<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Evar-insensitive terms (EConstr) | Jason Gross</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Evar-insensitive terms (EConstr)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Personal website of Jason Gross" />
<meta property="og:description" content="Personal website of Jason Gross" />
<link rel="canonical" href="http://localhost:4000/presentations/coq-workshop-2018-coq/dev/doc/econstr.html" />
<meta property="og:url" content="http://localhost:4000/presentations/coq-workshop-2018-coq/dev/doc/econstr.html" />
<meta property="og:site_name" content="Jason Gross" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Evar-insensitive terms (EConstr)" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/presentations/coq-workshop-2018-coq/dev/doc/econstr.html","headline":"Evar-insensitive terms (EConstr)","description":"Personal website of Jason Gross","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Jason Gross" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jason Gross</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/">Jason Gross</a><a class="page-link" href="/papers/lob-paper/README-SUPPLEMENTAL.html">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/fiat-crypto/pldi-2017/rebuttal.html">General Clarifications</a><a class="page-link" href="/papers/source/fiat-crypto/popl-2018/reviews.html">POPL ‘18 Paper #2 Reviews and Comments</a><a class="page-link" href="/papers/source/lob-paper/README-SUPPLEMENTAL.html">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/rewriting/rewriting.html">Rewriter</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/changes.html">Changes between Coq 8.7 and Coq 8.8</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/debugging.html">Debugging from Coq toplevel using Caml trace mechanism</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/econstr.html">Evar-insensitive terms (EConstr)</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/proof-engine.html">Tutorial on the new proof engine for ML tactic writers</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/xml-protocol.html">Coq XML Protocol</a><a class="page-link" href="/papers/lob-paper/">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/lob-paper/">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/presentations/coq-8.6-wishlist/">coq-8.6-wishlist</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/">Coq</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/ci/">Continuous Integration for the Coq Proof Assistant</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/ci/user-overlays/">Add overlays for your pull requests in this directory</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/test-suite/">Coq Test Suite</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Evar-insensitive terms (EConstr)</h1>
  </header>

  <div class="post-content">
    <h1 id="evar-insensitive-terms-econstr">Evar-insensitive terms (EConstr)</h1>

<p>Evar-insensitive terms were introduced in 8.7, following
<a href="https://github.com/coq/ceps/blob/master/text/010-econstr.md">CEP #10</a>. We will
not recap the motivations in this document and rather summarize the code changes
to perform.</p>

<h2 id="overview">Overview</h2>

<p>The essential datastructures are defined in
<a href="/engine/eConstr.mli">the <code class="language-plaintext highlighter-rouge">EConstr</code> module</a> module. It defines
the tactic counterparts of kernel data structures such as terms
(<code class="language-plaintext highlighter-rouge">EConstr.constr</code>), universes (<code class="language-plaintext highlighter-rouge">EConstr.ESorts.t</code>) and contexts
(<code class="language-plaintext highlighter-rouge">EConstr.*_context</code>).</p>

<p>The main difference with kernel-side types is that observing them requires
an evar-map at hand in order to normalize evars on the fly. The basic primitive
to observe an <code class="language-plaintext highlighter-rouge">EConstr.t</code> is the following function:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val kind : Evd.evar_map -&gt; t -&gt; (t, t, ESorts.t, EInstance.t) Constr.kind_of_term
(** Same as {!Constr.kind} except that it expands evars and normalizes
    universes on the fly. *)
</code></pre></div></div>

<p>Essentially, each time it sees an evar which happens to be defined in the
provided evar-map, it replaces it with the corresponding body and carries on.</p>

<p>Due to universe unification occuring at the tactic level, the same goes for
universe instances and sorts. See the <code class="language-plaintext highlighter-rouge">ESort</code> and <code class="language-plaintext highlighter-rouge">EInstance</code> modules in
<code class="language-plaintext highlighter-rouge">EConstr</code>.</p>

<p>This normalization is critical for the soundness of tactics. Before EConstr, a
lot of bugs were lurking in the code base, a few still are (most notably in
meta-based unification) and failure to respect the guidelines thereafter may
result in nasal demons.</p>

<h2 id="transition-path">Transition path</h2>

<h3 id="types">Types</h3>

<p>As a rule of thumb, all functions living at the tactic level should manipulate
<code class="language-plaintext highlighter-rouge">EConstr.t</code> instead of <code class="language-plaintext highlighter-rouge">Constr.t</code>, and similarly for the other data structures.</p>

<p>To ease the transition, the <code class="language-plaintext highlighter-rouge">EConstr</code> module defines a handful of aliases to
shadow the type names from the kernel.</p>

<p>It is recommended to perform the following replacement in headers.</p>
<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">(** Kernel types. You may remove the two following opens if you want. Beware
    that [kind_of_term] needs to be in scope if you use [EConstr.kind] so that
    you may still need to open one of the two. *)</span>
<span class="k">open</span> <span class="nc">Term</span>
<span class="k">open</span> <span class="nc">Constr</span>
<span class="c">(** Tactic types. Open this after to shadow kernel types. *)</span>
<span class="k">open</span> <span class="nc">EConstr</span>
</code></pre></div></div>

<p>Note that the <code class="language-plaintext highlighter-rouge">EConstr</code> module also redefines a <code class="language-plaintext highlighter-rouge">Vars</code> submodule.</p>

<h3 id="evar-map-passing">Evar-map-passing</h3>

<p>All functions deconstructing an econstr need to take an evar-map as a parameter.
Therefore, you need to pass one as an argument virtually everywhere.</p>

<p>In the Coq source code, it is recommended to take the evar-map as a first
argument called <code class="language-plaintext highlighter-rouge">sigma</code>, except if the function also takes an environment in
which case it is passed second. Namely, the two typical instances are:</p>
<div class="language-ocaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">foo</span> <span class="n">sigma</span> <span class="n">c</span> <span class="o">=</span> <span class="n">mycode</span>
<span class="k">val</span> <span class="n">foo</span> <span class="o">:</span> <span class="nn">Evd</span><span class="p">.</span><span class="n">evar_map</span> <span class="o">-&gt;</span> <span class="nn">EConstr</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Foo</span><span class="p">.</span><span class="n">t</span>

<span class="k">let</span> <span class="n">bar</span> <span class="n">env</span> <span class="n">sigma</span> <span class="n">c</span> <span class="o">=</span> <span class="n">mycode</span>
<span class="k">val</span> <span class="n">bar</span> <span class="o">:</span> <span class="nn">Environ</span><span class="p">.</span><span class="n">env</span> <span class="o">-&gt;</span> <span class="nn">Evd</span><span class="p">.</span><span class="n">evar_map</span> <span class="o">-&gt;</span> <span class="nn">EConstr</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nn">Bar</span><span class="p">.</span><span class="n">t</span>
</code></pre></div></div>

<p>The EConstr API makes the code much more sensitive to evar-maps, because a
lot of now useless normalizations were removed. Thus one should be cautious of
<strong>not</strong> dropping the evar-map when it has been updated, and should rather stick
to a strict state-passing discipline. Unsound primitives like
<code class="language-plaintext highlighter-rouge">Typing.unsafe_type_of</code> are also a known source of problems, so you should
replace them with the corresponding evar-map-returning function and thread it
properly.</p>

<h3 id="functions">Functions</h3>

<p>Many functions from <code class="language-plaintext highlighter-rouge">Constr</code> and <code class="language-plaintext highlighter-rouge">Term</code> are redefined to work on econstr in
the <code class="language-plaintext highlighter-rouge">EConstr</code> module, so that it is often enough to perform the <code class="language-plaintext highlighter-rouge">open</code> as
described above to replace them. Their type may differ though, because they now
need access to an evar-map. A lot of econstr-manipulating functions are also
defined in <a href="/engine/termops.mli"><code class="language-plaintext highlighter-rouge">Termops</code></a>.</p>

<p>Functions manipulating tactic terms and kernel terms share the same name if they
are the equivalent one of the other. Do not hesitate to grep Coq mli files to
find the equivalent of a function you want to port if it is neither in <code class="language-plaintext highlighter-rouge">EConstr</code>
nor in <code class="language-plaintext highlighter-rouge">Termops</code> (this should be very rare).</p>

<h3 id="conversion">Conversion</h3>

<p>Sometimes you do not have any other choice than calling kernel-side functions
on terms, and conversely to turn a kernel term into a tactic term.</p>

<p>There are two functions to do so.</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">EConstr.of_constr</code> turns kernel terms into tactic terms. It is currently
the physical identity, and thus O(1), but this may change in the future.</li>
  <li><code class="language-plaintext highlighter-rouge">EConstr.to_constr</code> turns tactic terms into kernel terms. It performs a
full-blown normalization of the given term, which is O(n) and potentially
costly.</li>
</ul>

<p>For performance reasons, avoiding to jump back and forth between kernel and
tactic terms is recommended.</p>

<p>There are also a few unsafe conversion functions that take advantage of the
fact that <code class="language-plaintext highlighter-rouge">EConstr.t</code> is internally the same as <code class="language-plaintext highlighter-rouge">Constr.t</code>. Namely,
<code class="language-plaintext highlighter-rouge">EConstr.Unsafe.to_constr</code> is the physical identity. It should <strong>not</strong> be used
in typical code and is instead provided for efficiency <strong>when you know what you
are doing</strong>. Either use it to reimplement low-level functions that happen to
be insensitive externally, or use it to provide backward compatibility with
broken code that relies on evar-sensitivity. <strong>Do not use it because it is
easier than stuffing evar-maps everywhere.</strong> You’ve been warned.</p>

<h2 id="notes">Notes</h2>

<p>The EConstr branch fixed a lot of eisenbugs linked to lack of normalization
everywhere, most notably in unification. It may also have introduced a few, so
if you see a change in behaviour <em>that looks like a bug</em>, please report it.
Obviously, unification is not specified, so it’s hard to tell apart, but still.</p>

<p>Efficiency has been affected as well. We now pay an overhead when observing a
term, but at the same time a lot of costly upfront normalizations were removed.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jason Gross</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jason Gross</li><li><a class="u-email" href="mailto:jgross@mit.edu">jgross@mit.edu</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/JasonGross"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">JasonGross</span></a></li><li><a href="https://www.twitter.com/diagram_chaser"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">diagram_chaser</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Personal website of Jason Gross</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
