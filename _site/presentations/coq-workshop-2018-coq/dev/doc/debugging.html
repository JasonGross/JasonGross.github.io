<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Debugging from Coq toplevel using Caml trace mechanism | Jason Gross</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Debugging from Coq toplevel using Caml trace mechanism" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Personal website of Jason Gross" />
<meta property="og:description" content="Personal website of Jason Gross" />
<link rel="canonical" href="http://localhost:4000/presentations/coq-workshop-2018-coq/dev/doc/debugging.html" />
<meta property="og:url" content="http://localhost:4000/presentations/coq-workshop-2018-coq/dev/doc/debugging.html" />
<meta property="og:site_name" content="Jason Gross" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Debugging from Coq toplevel using Caml trace mechanism" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/presentations/coq-workshop-2018-coq/dev/doc/debugging.html","headline":"Debugging from Coq toplevel using Caml trace mechanism","description":"Personal website of Jason Gross","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Jason Gross" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jason Gross</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/">Jason Gross</a><a class="page-link" href="/papers/lob-paper/README-SUPPLEMENTAL.html">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/fiat-crypto/pldi-2017/rebuttal.html">General Clarifications</a><a class="page-link" href="/papers/source/fiat-crypto/popl-2018/reviews.html">POPL ‘18 Paper #2 Reviews and Comments</a><a class="page-link" href="/papers/source/lob-paper/README-SUPPLEMENTAL.html">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/rewriting/rewriting.html">Rewriter</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/changes.html">Changes between Coq 8.7 and Coq 8.8</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/debugging.html">Debugging from Coq toplevel using Caml trace mechanism</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/econstr.html">Evar-insensitive terms (EConstr)</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/proof-engine.html">Tutorial on the new proof engine for ML tactic writers</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/xml-protocol.html">Coq XML Protocol</a><a class="page-link" href="/papers/lob-paper/">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/lob-paper/">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/presentations/coq-8.6-wishlist/">coq-8.6-wishlist</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/">Coq</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/ci/">Continuous Integration for the Coq Proof Assistant</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/ci/user-overlays/">Add overlays for your pull requests in this directory</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/test-suite/">Coq Test Suite</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Debugging from Coq toplevel using Caml trace mechanism</h1>
  </header>

  <div class="post-content">
    <h1 id="debugging-from-coq-toplevel-using-caml-trace-mechanism">Debugging from Coq toplevel using Caml trace mechanism</h1>

<ol>
  <li>Launch bytecode version of Coq (coqtop.byte)</li>
  <li>Access Ocaml toplevel using vernacular command ‘Drop.’</li>
  <li>Install load paths and pretty printers for terms, idents, … using
Ocaml command ‘#use “base_include”;;’ (use ‘#use “include”;;’ for 
installing the advanced term pretty printers)</li>
  <li>Use #trace to tell which function(s) to trace</li>
  <li>Go back to Coq toplevel with ‘go();;’</li>
  <li>Test your Coq command and observe the result of tracing your functions</li>
  <li>Freely switch from Coq to Ocaml toplevels with ‘Drop.’ and ‘go();;’</li>
</ol>

<p>You can avoid typing #use “include” (or “base_include”) after Drop
  by adding the following lines in your $HOME/.ocamlinit :</p>

<p>if Filename.basename Sys.argv.(0) = “coqtop.byte”
   then ignore (Toploop.use_silently Format.std_formatter “include”)</p>

<p>Hints: To remove high-level pretty-printing features (coercions,
  notations, …), use “Set Printing All”. It will affect the #trace
  printers too.</p>

<h1 id="debugging-with-ocamldebug-from-emacs">Debugging with ocamldebug from Emacs</h1>

<p>Requires <a href="https://github.com/ocaml/tuareg">Tuareg mode</a> in Emacs.<br />
   Coq must be configured with <code class="language-plaintext highlighter-rouge">-local</code> (<code class="language-plaintext highlighter-rouge">./configure -local</code>) and the
   byte-code version of <code class="language-plaintext highlighter-rouge">coqtop</code> must have been generated with <code class="language-plaintext highlighter-rouge">make byte</code>.</p>

<ol>
  <li>M-x camldebug</li>
  <li>give the binary name bin/coqtop.byte</li>
  <li>give ../dev/ocamldebug-coq</li>
  <li>source db  (to get pretty-printers)</li>
  <li>add breakpoints with C-x C-a C-b from the buffer displaying the ocaml
source</li>
  <li>get more help from ocamldebug manual
   run
     step
   back
   start
     next
     last
     print x (abbreviated into p x)
     …</li>
  <li>some hints:</li>
</ol>

<ul>
  <li>To debug a failure/error/anomaly, add a breakpoint in
Vernac.vernac_com at the with clause of the “try … interp com
with …” block, then go “back” a few steps to find where the
failure/error/anomaly has been raised</li>
  <li>Alternatively, for an error or an anomaly, add breakpoints in the middle<br />
of each of error* functions or anomaly* functions in lib/util.ml</li>
  <li>If “source db” fails, do a “make printers” and try again (it should build
top_printers.cmo and the core cma files).</li>
  <li>If you build Coq with an OCaml version earlier than 4.06, and have the 
OCAMLRUNPARAM environment variable set, Coq may hang on startup when run 
from the debugger. If this happens, unset the variable, re-start Emacs, and 
run the debugger again.</li>
</ul>

<h1 id="debugging-with-ocamldebug-from-the-command-line">Debugging with ocamldebug from the command line</h1>

<p>In the <code class="language-plaintext highlighter-rouge">coq</code> directory:</p>
<ol>
  <li>(on Cygwin/Windows) Pass the <code class="language-plaintext highlighter-rouge">-no-custom</code> option to the <code class="language-plaintext highlighter-rouge">configure</code> script before building Coq.</li>
  <li>Run <code class="language-plaintext highlighter-rouge">make</code> (to compile the .v files)</li>
  <li>Run <code class="language-plaintext highlighter-rouge">make byte</code></li>
  <li>(on Cygwin/Windows) Add the full pathname of the directory <code class="language-plaintext highlighter-rouge">.../kernel/byterun</code> to your bash PATH.
Alternatively, copy the file <code class="language-plaintext highlighter-rouge">kernel/byterun/dllcoqrun.dll</code> to a directory that is in the PATH.  (The
CAML_LD_LIBRARY_PATH mechanism described at the end of INSTALL isn’t working.)</li>
  <li>Run <code class="language-plaintext highlighter-rouge">dev/ocamldebug-coq bin/coqtop.byte</code>  (on Cygwin/Windows, use <code class="language-plaintext highlighter-rouge">... bin/coqtop.byte.exe</code>)</li>
  <li>Enter <code class="language-plaintext highlighter-rouge">source db</code> to load printers</li>
  <li>Enter <code class="language-plaintext highlighter-rouge">set arguments -coqlib .</code> so Coq can find plugins, theories, etc.</li>
  <li>See the ocamldebug manual for more information.  A few points:
    <ul>
      <li>use <code class="language-plaintext highlighter-rouge">break @ Printer 501</code> to set a breakpoint on line 501 in the Printer module (printer.ml).
<code class="language-plaintext highlighter-rouge">break</code> can be abbreviated as <code class="language-plaintext highlighter-rouge">b</code>.</li>
      <li><code class="language-plaintext highlighter-rouge">backtrace</code> or <code class="language-plaintext highlighter-rouge">bt</code> to see the call stack</li>
      <li><code class="language-plaintext highlighter-rouge">step</code> or <code class="language-plaintext highlighter-rouge">s</code> goes into called functions; <code class="language-plaintext highlighter-rouge">next</code> or <code class="language-plaintext highlighter-rouge">n</code> skips over them</li>
      <li><code class="language-plaintext highlighter-rouge">list</code> or <code class="language-plaintext highlighter-rouge">li</code> shows the code just before and after the current stack frame</li>
      <li><code class="language-plaintext highlighter-rouge">print &lt;var&gt;</code> or <code class="language-plaintext highlighter-rouge">p &lt;var&gt;</code> to see the value of a variable
Note that <code class="language-plaintext highlighter-rouge">make byte</code> doesn’t recompile .v files.  <code class="language-plaintext highlighter-rouge">make</code> recompiles all of them if there
are changes in any .ml file–safer but much slower.</li>
    </ul>
  </li>
</ol>

<h1 id="global-gprof-based-profiling">Global gprof-based profiling</h1>

<p>Coq must be configured with option -profile</p>

<ol>
  <li>Run native Coq which must end normally (use Quit or option -batch)</li>
  <li>gprof ./coqtop gmon.out</li>
</ol>

<h1 id="per-function-profiling">Per function profiling</h1>

<p>To profile function foo in file bar.ml, add the following lines, just
   after the definition of the function:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code> let fookey = CProfile.declare_profile "foo";;
 let foo a b c = CProfile.profile3 fookey foo a b c;;
</code></pre></div></div>

<p>where foo is assumed to have three arguments (adapt using
   Profile.profile1, Profile. profile2, etc).</p>

<p>This has the effect to cumulate the time passed in foo under a
   line of name “foo” which is displayed at the time coqtop exits.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jason Gross</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jason Gross</li><li><a class="u-email" href="mailto:jgross@mit.edu">jgross@mit.edu</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/JasonGross"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">JasonGross</span></a></li><li><a href="https://www.twitter.com/diagram_chaser"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">diagram_chaser</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Personal website of Jason Gross</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
