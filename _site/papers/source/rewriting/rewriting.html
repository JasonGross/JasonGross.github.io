<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Rewriter | Jason Gross</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Rewriter" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Personal website of Jason Gross" />
<meta property="og:description" content="Personal website of Jason Gross" />
<link rel="canonical" href="http://localhost:4000/papers/source/rewriting/rewriting.html" />
<meta property="og:url" content="http://localhost:4000/papers/source/rewriting/rewriting.html" />
<meta property="og:site_name" content="Jason Gross" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Rewriter" />
<script type="application/ld+json">
{"@type":"WebPage","url":"http://localhost:4000/papers/source/rewriting/rewriting.html","headline":"Rewriter","description":"Personal website of Jason Gross","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Jason Gross" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jason Gross</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/">Jason Gross</a><a class="page-link" href="/papers/lob-paper/README-SUPPLEMENTAL.html">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/fiat-crypto/pldi-2017/rebuttal.html">General Clarifications</a><a class="page-link" href="/papers/source/fiat-crypto/popl-2018/reviews.html">POPL ‘18 Paper #2 Reviews and Comments</a><a class="page-link" href="/papers/source/lob-paper/README-SUPPLEMENTAL.html">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/rewriting/rewriting.html">Rewriter</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/changes.html">Changes between Coq 8.7 and Coq 8.8</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/debugging.html">Debugging from Coq toplevel using Caml trace mechanism</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/econstr.html">Evar-insensitive terms (EConstr)</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/proof-engine.html">Tutorial on the new proof engine for ML tactic writers</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/doc/xml-protocol.html">Coq XML Protocol</a><a class="page-link" href="/papers/lob-paper/">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/papers/source/lob-paper/">Lӧb’s Theorem: A functional pearl of dependently typed quining</a><a class="page-link" href="/presentations/coq-8.6-wishlist/">coq-8.6-wishlist</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/">Coq</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/ci/">Continuous Integration for the Coq Proof Assistant</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/dev/ci/user-overlays/">Add overlays for your pull requests in this directory</a><a class="page-link" href="/presentations/coq-workshop-2018-coq/test-suite/">Coq Test Suite</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">Rewriter</h1>
  </header>

  <div class="post-content">
    <h1 id="rewriter">Rewriter</h1>

<h2 id="introduction">Introduction</h2>

<ul>
  <li>The goal of the rewriter is to take an abstract syntax tree and perform reduction or rewriting.</li>
  <li>There are three things that happen in rewriting: beta reduction, let-lifting, and replacement of rewrite patterns with their substitutions
    <ul>
      <li>Beta reduction is replacing <code class="language-plaintext highlighter-rouge">(λ x. F) y</code> with <code class="language-plaintext highlighter-rouge">F[x ⇒ y]</code>.
We do this with a normalization-by-evaluation strategy.</li>
      <li>Let-lifting involves replacing <code class="language-plaintext highlighter-rouge">f (let x := y in z)</code> with <code class="language-plaintext highlighter-rouge">let x := y in f x</code>.
Note that for higher-order functions, we push lets under lambads, rather than lifting them;
  we replace <code class="language-plaintext highlighter-rouge">f (let x := y in (λ z. w))</code> with <code class="language-plaintext highlighter-rouge">f (λ z. let x := y in w)</code>.
This is done for the convenience of not having to track the let-binding-structure at every level of arrow.</li>
      <li>Replacing rewriting patterns with substitutions involves, for example, replacing <code class="language-plaintext highlighter-rouge">x + 0</code> with <code class="language-plaintext highlighter-rouge">x</code>.</li>
      <li>There’s actually a fourth thing, which happens during let-lifting:
  some let binders get inlined:
  In particular, any let-bound value which is a combination of variables, literals, and the identifiers <code class="language-plaintext highlighter-rouge">nil</code>, <code class="language-plaintext highlighter-rouge">cons</code>, <code class="language-plaintext highlighter-rouge">pair</code>, <code class="language-plaintext highlighter-rouge">fst</code>, <code class="language-plaintext highlighter-rouge">snd</code>, <code class="language-plaintext highlighter-rouge">Z.opp</code>, <code class="language-plaintext highlighter-rouge">Z.cast</code>, and <code class="language-plaintext highlighter-rouge">Z.cast2</code> gets inlined.
If the let-bound variable contains any lambdas, lets, or applications of identifiers other than the above, then it is not inlined.</li>
    </ul>
  </li>
</ul>

<h2 id="beta-reduction-and-let-lifting">Beta-Reduction and Let-Lifting</h2>
<ul>
  <li>We use the following data-type:
    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">value'</span><span class="w"> </span><span class="o">(</span><span class="no">with_lets</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="no">with_lets</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value'</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value'</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="no">d</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">value'</span><span class="w"> </span><span class="no">false</span><span class="pi">.</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">value'</span><span class="w"> </span><span class="no">true</span><span class="pi">.</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>Here are some examples:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">value Z := UnderLets (expr Z)</code></li>
      <li><code class="language-plaintext highlighter-rouge">value (Z -&gt; Z) := expr Z -&gt; UnderLets (expr Z)</code></li>
      <li><code class="language-plaintext highlighter-rouge">value (Z -&gt; Z -&gt; Z) := expr Z -&gt; expr Z -&gt; UnderLets (expr Z)</code></li>
      <li><code class="language-plaintext highlighter-rouge">value ((Z -&gt; Z) -&gt; Z) := (expr Z -&gt; UnderLets (expr Z)) -&gt; UnderLets (expr Z)</code></li>
    </ul>
  </li>
  <li>By converting expressions to values and using normalization-by-evaluation, we get beta reduction in the standard way.</li>
  <li>We use a couple of splicing combinators to perform let-lifting:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Fixpoint splice {A B} (x : UnderLets A) (e : A -&gt; UnderLets B) : UnderLets B</code></li>
      <li><code class="language-plaintext highlighter-rouge">Fixpoint splice_list {A B} (ls : list (UnderLets A)) (e : list A -&gt; UnderLets B) : UnderLets B</code></li>
      <li><code class="language-plaintext highlighter-rouge">Fixpoint splice_under_lets_with_value {T t} (x : UnderLets T) : (T -&gt; value_with_lets t) -&gt; value_with_lets t</code></li>
      <li><code class="language-plaintext highlighter-rouge">Definition splice_value_with_lets {t t'} : value_with_lets t -&gt; (value t -&gt; value_with_lets t') -&gt; value_with_lets t'</code></li>
    </ul>
  </li>
  <li>There’s one additional building block, which is responsible for deciding which lets to inline:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">Fixpoint reify_and_let_binds_base_cps {t : base.type} : expr t -&gt; forall T, (expr t -&gt; UnderLets T) -&gt; UnderLets T</code></li>
    </ul>
  </li>
  <li>As is typical for NBE, we make use of a reify-reflect pair of functions:
    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">reify</span><span class="w"> </span><span class="o">{</span><span class="no">with_lets</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value'</span><span class="w"> </span><span class="no">with_lets</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="kp">with</span><span class="w"> </span><span class="no">reflect</span><span class="w"> </span><span class="o">{</span><span class="no">with_lets</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value'</span><span class="w"> </span><span class="no">with_lets</span><span class="w"> </span><span class="no">t</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>The NBE part of the rewriter, responsible for beta reduction and let-lifting, is now expressible:
    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="s2">"e &lt;---- e' ; f"</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">splice_value_with_lets</span><span class="w"> </span><span class="no">e'</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">f</span><span class="o">%</span><span class="no">under_lets</span><span class="o">))</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">under_lets_scope</span><span class="pi">.</span><span class="w">
</span><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="s2">"e &lt;----- e' ; f"</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">splice_under_lets_with_value</span><span class="w"> </span><span class="no">e'</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">f</span><span class="o">%</span><span class="no">under_lets</span><span class="o">))</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">under_lets_scope</span><span class="pi">.</span><span class="w">

</span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">rewrite_head</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">&lt;----</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="p">;</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">LetIn</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">&lt;----</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">x</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">xv</span><span class="w"> </span><span class="o">&lt;-----</span><span class="w"> </span><span class="no">reify_and_let_binds_cps</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">Base</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="o">(</span><span class="no">reflect</span><span class="w"> </span><span class="no">xv</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">Var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Base_value</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">Abs</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">under_lets</span><span class="pi">.</span><span class="w">
</span></code></pre></div>    </div>
  </li>
</ul>

<h2 id="rewriting">Rewriting</h2>
<h3 id="there-are-three-parts-and-one-additional-detail-to-rewriting">There are three parts and one additional detail to rewriting:</h3>
<ul>
  <li>Pattern matching compilation</li>
  <li>Decision tree evaluation</li>
  <li>Rewriting with a particular rewrite rule</li>
  <li>Rewriting again in the output of a rewrite rule</li>
</ul>

<h3 id="overview">Overview</h3>
<ul>
  <li>Rewrite rules are patterns (things like <code class="language-plaintext highlighter-rouge">?? + #?</code> meaning “any variable added to any literal”) paired with dependently typed replacement values indexed over the pattern.
The replacement value takes in types for each type variable, <code class="language-plaintext highlighter-rouge">value</code>s for each variable (<code class="language-plaintext highlighter-rouge">??</code>), and interpreted values for each literal wildcard.
Additionally, any identifier that takes extra parameters will result in the parameters being passed into the rewrite rule.
The return type for replacement values is an option UnderLets expr of the correct type.</li>
  <li>A list of rewrite rules is compiled into (a) a decision tree, and (b) a rewriter that functions by evaluating that decision tree.</li>
</ul>

<h3 id="the-small-extra-detail-rewriting-again-in-the-output-of-a-rewrite-rule">The small extra detail: Rewriting again in the output of a rewrite rule</h3>
<ul>
  <li>We tie the entire rewriter together with a fueled repeat_rewrite;
 the fuel is set to the length of the list of rewrite rules.
This means that as long as the intended rewrite sequences form a DAG, then the rewriter will find all occurrences.
    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Notation</span><span class="w"> </span><span class="no">nbe</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">reflect</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc</span><span class="o">))).</span><span class="w">

</span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">repeat_rewrite</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">rewrite_head</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(@</span><span class="no">expr</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">),</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">fuel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">nat</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_bottomup</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">rewrite_head</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">e'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">fuel</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">Datatypes</span><span class="p">.</span><span class="no">O</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">nbe</span><span class="w"> </span><span class="no">e'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">Datatypes</span><span class="p">.</span><span class="no">S</span><span class="w"> </span><span class="no">fuel'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">repeat_rewrite</span><span class="w"> </span><span class="no">rewrite_head</span><span class="w"> </span><span class="no">fuel'</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t'</span><span class="o">)</span><span class="w"> </span><span class="no">e'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="o">%</span><span class="no">under_lets</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="pi">.</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>This feature is used to rewrite again with the literal-list append rule (appending two lists of cons cells results in a single list of cons cells) in the output of the <code class="language-plaintext highlighter-rouge">flat_map</code> rule (<code class="language-plaintext highlighter-rouge">flat_map</code> on a literal list of cons cells maps the function over the list and joins the resulting lists with <code class="language-plaintext highlighter-rouge">List.app</code>).</li>
</ul>

<h3 id="pattern-matching-compilation">Pattern matching compilation</h3>
<ul>
  <li>This part of the rewriter does not need to be verified, because the rewriter-compiler is proven correct independent of the decision tree used.
Note that we could avoid this stage all together, and simply try each rewrite rule in sequence.
We include this for efficiency.
TODO: perf comparison of this method.</li>
  <li>We follow <em>Compiling Pattern Matching to Good Decision Trees</em> by Luc Maranget (http://moscova.inria.fr/~maranget/papers/ml05e-maranget.pdf), which describes compilation of pattern matches in OCaml to a decision tree that eliminates needless repeated work (for example, decomposing an expression into <code class="language-plaintext highlighter-rouge">x + y + z</code> only once even if two different rules match on that pattern).</li>
  <li>We do <em>not</em> bother implementing the optimizations that they describe for finding minimal decision trees.
TODO: Mention something about future work?  Perf testing?</li>
  <li>The type of decision trees
    <ul>
      <li>A <code class="language-plaintext highlighter-rouge">decision_tree</code> describes how to match a vector (or list) of patterns against a vector of expressions. The cases of a <code class="language-plaintext highlighter-rouge">decision_tree</code> are:
        <ul>
          <li><code class="language-plaintext highlighter-rouge">TryLeaf k onfailure</code>: Try the kth rewrite rule; if it fails, keep going with <code class="language-plaintext highlighter-rouge">onfailure</code></li>
          <li><code class="language-plaintext highlighter-rouge">Failure</code>: Abort; nothing left to try</li>
          <li><code class="language-plaintext highlighter-rouge">Switch icases app_case default</code>: With the first element of the vector, match on its kind; if it is an identifier matching something in <code class="language-plaintext highlighter-rouge">icases</code>, remove the first element of the vector run that decision tree; if it is an application and <code class="language-plaintext highlighter-rouge">app_case</code> is not <code class="language-plaintext highlighter-rouge">None</code>, try the <code class="language-plaintext highlighter-rouge">app_case</code> decision_tree, replacing the first element of each vector with the two elements of the function and the argument its applied to; otherwise, don’t modify the vectors, and use the <code class="language-plaintext highlighter-rouge">default</code> decision tree.</li>
          <li><code class="language-plaintext highlighter-rouge">Swap i cont</code>: Swap the first element of the vector with the ith element, and keep going with <code class="language-plaintext highlighter-rouge">cont</code></li>
        </ul>
      </li>
      <li>The inductive type:
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Inductive</span><span class="w"> </span><span class="no">decision_tree</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">TryLeaf</span><span class="w"> </span><span class="o">(</span><span class="no">k</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">nat</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">onfailure</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Failure</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Switch</span><span class="w"> </span><span class="o">(</span><span class="no">icases</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">(</span><span class="no">raw_pident</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">app_case</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">default</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Swap</span><span class="w"> </span><span class="o">(</span><span class="no">i</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">nat</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">cont</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">).</span><span class="w">
</span></code></pre></div>        </div>
      </li>
    </ul>
  </li>
  <li>Raw identifiers
    <ul>
      <li>Note that the type of <code class="language-plaintext highlighter-rouge">icases</code>, the list of identifier cases in the <code class="language-plaintext highlighter-rouge">Switch</code> constructor above, maps what we call a <code class="language-plaintext highlighter-rouge">raw_pident</code> (“p” for “pattern”) to a decision tree.  The rewriter is parameterized over a type of <code class="language-plaintext highlighter-rouge">raw_pident</code>s, which is instantiated with a python-generated inductive type which names all of the identifiers we care about, except without any arguments.  We call them “raw” because they are not type-indexed.</li>
      <li>An example where this is important: We want to be able to express a decision tree for the pattern <code class="language-plaintext highlighter-rouge">fst (x, y)</code>.  This involves an application of the identifier <code class="language-plaintext highlighter-rouge">fst</code> to a pair.  We want to be able to talk about “<code class="language-plaintext highlighter-rouge">fst</code>, of any type” in the decision tree, without needing to list out all of the possible type arguments to <code class="language-plaintext highlighter-rouge">fst</code>.</li>
    </ul>
  </li>
  <li>Swap vs indices
    <ul>
      <li>One design decision we copy from <em>Compiling Pattern Matching to Good Decision Trees</em> is to have a <code class="language-plaintext highlighter-rouge">Swap</code> case.  We could instead augment each <code class="language-plaintext highlighter-rouge">Switch</code> with the index in the vector being examined.  If we did this, we’d need to talk about splicing a new list into the middle of an existing list, which is harder than talking about swapping two indices of a list.</li>
      <li>Note that swapping is <em>significantly</em> more painful over typed patterns and terms than over untyped ones.  If we index our vectors over a list of types, then we need to swap the types, and later swap them back (when reconstructing the term for evaluation), and then we need to unswap the terms in a way that has unswap (swap ls) on the term level <em>judgmentally</em> indexed on the type level over the same index-list as ls.  This is painful, and is an example of pain caused by picking the wrong abstraction, in a way that causes exponential blow-up with each extra layer of dependency added.</li>
    </ul>
  </li>
  <li>The type of patterns
    <ul>
      <li>Patterns describe the LHS of rewrite rules, or the LHS of cases of a match statement.  We index patterns over their type:
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Inductive</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">positive</span><span class="o">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">type_base</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="o">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">prod</span><span class="w"> </span><span class="o">(</span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">(</span><span class="no">A</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">).</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>The type of a pattern is either an arrow or a pattern.base.type, and a pattern.base.type is either a positive-indexed type-variable (written ‘1, ‘2, …), or a product, a list, or a standard base.type (with no type-variables)</li>
      <li>A pattern is either a wildcard, an identifier, or an application of patterns.  Note that our rewriter only handles fully applied patterns, i.e., only things of type <code class="language-plaintext highlighter-rouge">pattern (type.base t)</code>, not things of type <code class="language-plaintext highlighter-rouge">pattern t</code>.  (This is not actually true.  The rewriter can kind-of handle non-fully-applied patterns, but the Gallina won’t reduce in the right places, so we restrict ourselves to fully-applied patterns.)
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Inductive</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="o">{</span><span class="no">ident</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Wildcard</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Ident</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">App</span><span class="w"> </span><span class="o">{</span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="o">(</span><span class="no">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">d</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="no">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">s</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">d</span><span class="pi">.</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>Pattern matching <em>compilation</em> to decision trees actually uses a more raw version of patterns, which come from these patterns:
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Module</span><span class="w"> </span><span class="no">Raw</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Inductive</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="o">{</span><span class="no">ident</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Wildcard</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Ident</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">App</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="o">).</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">Raw</span><span class="pi">.</span><span class="w">
</span></code></pre></div>        </div>
        <ul>
          <li>This is because the pattern matching compilation algorithm is morally done over untyped patterns and terms.</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>The definitions
    <ul>
      <li>TODO: How much detail should I include about intermediate things?</li>
      <li>Pattern matching compilation at the top-level, takes in a list of patterns, and spits out a decision tree.  Note that each <code class="language-plaintext highlighter-rouge">TryLeaf</code> node in the decision tree has an index <code class="language-plaintext highlighter-rouge">k</code>, which denotes the index in this initial list of patterns of the chosen rewrite rule.</li>
      <li>The workhorse of pattern matching compilation is <code class="language-plaintext highlighter-rouge">Fixpoint compile_rewrites' (fuel : nat) (pattern_matrix : list (nat * list rawpattern)) : option decision_tree</code>.  This takes the list rows of the matrix of patterns, each one containing a list (vector in the original source paper) of patterns to match against, and the original index of the rewrite rule that this list of patterns came from.  Note that all of these lists are in fact the same length, but we do not track this invariant anywhere, because it would add additional overhead for little-to-no gain.
        <ul>
          <li>The <code class="language-plaintext highlighter-rouge">compile_rewrites'</code> procedure operates as follows:
            <ul>
              <li>If we are out of fuel, then we fail (return <code class="language-plaintext highlighter-rouge">None</code>)</li>
              <li>If the <code class="language-plaintext highlighter-rouge">pattern_matrix</code> is empty, we indicate <code class="language-plaintext highlighter-rouge">Failure</code> to match</li>
              <li>If the first row is made up entirely of wildcards, we indicate to <code class="language-plaintext highlighter-rouge">TryLeaf</code> with the rewrite rule corresponding to the first row, and then to continue on with the decision tree corresponding to the rest of the rows.</li>
              <li>If the first element of the first row is a wildcard, we <code class="language-plaintext highlighter-rouge">Swap</code> the first element with the index <code class="language-plaintext highlighter-rouge">i</code> of the first non-wildcard pattern in the first row.  We then swap the first element with the <code class="language-plaintext highlighter-rouge">i</code>th element in every row of the matrix, and continue on with the result of compiling that matrix.</li>
              <li>If the first element of the first row is not a wildcard, we issue a <code class="language-plaintext highlighter-rouge">Switch</code>.  We first split the pattern matrix by finding the first row where the first element in that row is a wildcard, and aggregating that row and all rows after it into the <code class="language-plaintext highlighter-rouge">default_pattern_matrix</code>.  We partition the rows before that row into the ones where the first element is an application node and the ones where the first element is an identifier node.  The application nodes get split into the pattern for the function, and the pattern for the argument, and these two are prepended to the row.  We group the rows that start with identifier patterns into groups according to the pattern identifier at the beginning of the row, and then take the tail of each of these rows.  We then compile all of these decision trees to make up the Switch case.</li>
              <li>In code, this looks like:
                <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">compile_rewrites_step</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">compile_rewrites</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">(</span><span class="no">nat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">rawpattern</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">pattern_matrix</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">(</span><span class="no">nat</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">rawpattern</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">decision_tree</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">pattern_matrix</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">Failure</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="o">(</span><span class="no">n1</span><span class="o">,</span><span class="w"> </span><span class="no">p1</span><span class="o">)</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">ps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">get_index_of_first_non_wildcard</span><span class="w"> </span><span class="no">p1</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="c">(* p1 is all wildcards *)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">onfailure</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">compile_rewrites</span><span class="w"> </span><span class="no">ps</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">TryLeaf</span><span class="w"> </span><span class="no">n1</span><span class="w"> </span><span class="no">onfailure</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="nn">Datatypes</span><span class="p">.</span><span class="no">O</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="k">'</span><span class="o">(</span><span class="no">pattern_matrix</span><span class="o">,</span><span class="w"> </span><span class="no">default_pattern_matrix</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">split_at_first_pattern_wildcard</span><span class="w"> </span><span class="no">pattern_matrix</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">default_case</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">compile_rewrites</span><span class="w"> </span><span class="no">default_pattern_matrix</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">app_case</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">contains_pattern_app</span><span class="w"> </span><span class="no">pattern_matrix</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">then</span><span class="w"> </span><span class="no">option_map</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">compile_rewrites</span><span class="w"> </span><span class="o">(</span><span class="nn">Option</span><span class="p">.</span><span class="nn">List</span><span class="p">.</span><span class="no">map</span><span class="w"> </span><span class="no">filter_pattern_app</span><span class="w"> </span><span class="no">pattern_matrix</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">else</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">None</span><span class="o">)</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">pidcs</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">get_unique_pattern_ident</span><span class="w"> </span><span class="no">pattern_matrix</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">icases</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nn">Option</span><span class="p">.</span><span class="nn">List</span><span class="p">.</span><span class="no">map</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">pidc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">option_map</span><span class="w"> </span><span class="o">(</span><span class="no">pair</span><span class="w"> </span><span class="no">pidc</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">compile_rewrites</span><span class="w"> </span><span class="o">(</span><span class="nn">Option</span><span class="p">.</span><span class="nn">List</span><span class="p">.</span><span class="no">map</span><span class="w"> </span><span class="o">(</span><span class="no">filter_pattern_pident</span><span class="w"> </span><span class="no">pidc</span><span class="o">)</span><span class="w"> </span><span class="no">pattern_matrix</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">pidcs</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Switch</span><span class="w"> </span><span class="no">icases</span><span class="w"> </span><span class="no">app_case</span><span class="w"> </span><span class="no">default_case</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">i</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">pattern_matrix'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">map</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="k">'</span><span class="o">(</span><span class="no">n</span><span class="o">,</span><span class="w"> </span><span class="no">ps</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">n</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">swap_list</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">ps</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">ps'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">ps'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="c">(* should be impossible *)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">pattern_matrix</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">d</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">compile_rewrites</span><span class="w"> </span><span class="no">pattern_matrix'</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Swap</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">d</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                </div>
              </li>
            </ul>
          </li>
          <li>We wrap <code class="language-plaintext highlighter-rouge">compile_rewrites'</code> in a definition <code class="language-plaintext highlighter-rouge">compile_rewrites</code> which extracts the well-typed patterns from a list of rewrite rules, associates them to indices, and strips the typing information off of the patterns to create raw (untyped) patterns.</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="decision-tree-evaluation">Decision Tree Evaluation</h3>
<ul>
  <li>The next step in rewriting is to evaluate the decision tree to construct Gallina procedure that takes in an unknown (at rewrite-rule-compile-time) AST and performs the rewrite.  This is broken up into two steps.  The first step is to create the <code class="language-plaintext highlighter-rouge">match</code> structure that exposes all of the relevant information in the AST, and picks which rewrite rules to try in which order, and glues together failure and success of rewriting.  The second step is to actually try to rewrite with a given rule, under the assumption that enough structure has been exposed.</li>
  <li>Because we have multiple phases of compilation, we need to track which information we have (and therefore can perform reduction on) when we know only the patterns but not the AST being rewritten in, and which reductions have to wait until we know the AST.  The way we track this information is by creating a wrapper type for ASTs.  Note that the wrapper type is not indexed over type codes, because pattern matching compilation naturally operates over untyped terms, and adjusting it to work when indexed over a vector of types is painful.</li>
  <li>The wrapper type, and revealing structure
    <ul>
      <li>Because different rewrite rules require different amounts of structure, we want to feed in only as much structure as is required for a given rewrite rule.  For example, if we have one rewrite rule that is looking at <code class="language-plaintext highlighter-rouge">(? + ?) + ?</code>, and another that is looking at <code class="language-plaintext highlighter-rouge">? + 0</code>, we want to feed in the argument to the top-level <code class="language-plaintext highlighter-rouge">+</code> into the second rewrite rule, not a reassembled version of all of the different things an expression might be after checking for <code class="language-plaintext highlighter-rouge">+</code>-like structure of the first argument.  If we did not do this, every rewrite rule replacement pattern would end up being as complicated as the deepest rewrite rule being considered, and we expect this would incur performance overhead.  TODO: Perf testing?</li>
      <li>Because we want our rewrite-rule-compilation to happen by reduction in Coq, we define many operations in CPS-style, so that we can carefully manage the exact judgmental structures of the discriminees of <code class="language-plaintext highlighter-rouge">match</code> statements.</li>
      <li>An <code class="language-plaintext highlighter-rouge">Inductive rawexpr : Type</code> is one of the following things:
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Inductive</span><span class="w"> </span><span class="no">rawexpr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="o">(</span><span class="no">known</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">t'</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">alt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t'</span><span class="o">)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">alt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="o">).</span><span class="w">
</span></code></pre></div>        </div>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">rIdent known t idc t' alt</code> - an identifier <code class="language-plaintext highlighter-rouge">idc : ident t</code>, whose unrevealed structure is <code class="language-plaintext highlighter-rouge">alt : expr t'</code>.  The boolean <code class="language-plaintext highlighter-rouge">known</code> indicates if the identifier is known to be simple enough that we can fully reduce matching on its type arguments during rewrite-rule-compilation-time.  For example, if we know an identifier to be <code class="language-plaintext highlighter-rouge">Z.add</code> (perhaps because we have matched on it already), we can reduce equality tests against the type.  However, if an identifier is <code class="language-plaintext highlighter-rouge">nil T</code>, we are not guaranteed to know the type of the list judgmentally, and so we do not want to reduce type-equality tests against the list.  Note that type-equality tests and type-transports are introduced as the least-evil thing we could find to cross the broken abstraction barrier between the untyped terms of pattern matching compilation, and the typed PHOASTs that we are operating on.</li>
          <li><code class="language-plaintext highlighter-rouge">rApp f x t alt</code> is the application of the <code class="language-plaintext highlighter-rouge">rawexpr</code> <code class="language-plaintext highlighter-rouge">f</code> to the <code class="language-plaintext highlighter-rouge">rawexpr</code> <code class="language-plaintext highlighter-rouge">x</code>, whose unrevealed structure is <code class="language-plaintext highlighter-rouge">alt : expr t</code>.</li>
          <li><code class="language-plaintext highlighter-rouge">rExpr t e</code> is a not-as-yet revealed expression <code class="language-plaintext highlighter-rouge">e : expr t</code>.</li>
          <li><code class="language-plaintext highlighter-rouge">rValue t e</code> is an unrevealed value <code class="language-plaintext highlighter-rouge">e : value t</code>.  Such NBE-style values may contain thunked computation, such as deferred rewriting opportunities.  This is essential for fully evaluating rewriting in expressions such as <code class="language-plaintext highlighter-rouge">map (fun x =&gt; x + x + 0) ls</code>, where you want to rewrite away the <code class="language-plaintext highlighter-rouge">map</code> (when <code class="language-plaintext highlighter-rouge">ls</code> is a concrete list of cons cells), the <code class="language-plaintext highlighter-rouge">+ 0</code> (always), and the <code class="language-plaintext highlighter-rouge">x + x</code> whenever <code class="language-plaintext highlighter-rouge">x</code> is a literal (which you do not know until you have distributed the function over the list).  Allowing thunked computation in the ASTs allows us to do all of this rewriting in a single pass.</li>
        </ul>
      </li>
      <li>Revealing structure: <code class="language-plaintext highlighter-rouge">Definition reveal_rawexpr_cps (e : rawexpr) : ~&gt; rawexpr</code>
        <ul>
          <li>For the sake of proofs, we actually define a slightly more general version of revealing structure, which allows us to specify whether or not we have already matched against the putative identifier at the top-level of the <code class="language-plaintext highlighter-rouge">rawexpr</code>.</li>
          <li>The code:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">reveal_rawexpr_cps_gen</span><span class="w"> </span><span class="o">(</span><span class="no">assume_known</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">~&gt;</span><span class="w"> </span><span class="no">rawexpr</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">e</span><span class="o">,</span><span class="w"> </span><span class="no">assume_known</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="no">r</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="no">r</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">rIdent</span><span class="w"> </span><span class="o">(</span><span class="kr">match</span><span class="w"> </span><span class="no">assume_known</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="kr">end</span><span class="o">)</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">rApp</span><span class="w"> </span><span class="o">(</span><span class="no">rExpr</span><span class="w"> </span><span class="no">f</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rExpr</span><span class="w"> </span><span class="no">x</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">r</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">alt</span><span class="o">,</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">rIdent</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">alt</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">e'</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">e'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>To reveal a <code class="language-plaintext highlighter-rouge">rawexpr</code>, CPS-style, we first match on the <code class="language-plaintext highlighter-rouge">rawexpr</code>.
            <ul>
              <li>If it is an <code class="language-plaintext highlighter-rouge">rExpr</code>, or a <code class="language-plaintext highlighter-rouge">rValue</code> at a base type (and thus just an expression), we then match on the resulting expression.
                <ul>
                  <li>If it is an identifier or an application node, we encode that, and then invoke the continuation</li>
                  <li>Otherwise, we invoke the continuation with the existing <code class="language-plaintext highlighter-rouge">rExpr</code> or <code class="language-plaintext highlighter-rouge">rValue</code>, because there was no more accessible structure to reveal; we do not allow matching on lambdas syntactically.</li>
                </ul>
              </li>
              <li>If it is an identifier and we are hard-coding the <code class="language-plaintext highlighter-rouge">known</code> status about if matches on the type of the identifier can be reduced, then we re-assemble the <code class="language-plaintext highlighter-rouge">rIdent</code> node with the new <code class="language-plaintext highlighter-rouge">known</code> status and invoke the continuation.</li>
              <li>Otherwise, we just invoke the continuation on the reassembled <code class="language-plaintext highlighter-rouge">rawexpr</code>.</li>
            </ul>
          </li>
          <li>Correctness conditions
            <ul>
              <li>There are a couple of properties that must hold of <code class="language-plaintext highlighter-rouge">reveal_rawexpr_cps</code>.</li>
              <li>The first is a <code class="language-plaintext highlighter-rouge">cps_id</code> rule, which says that applying <code class="language-plaintext highlighter-rouge">reveal_rawexpr_cps</code> to any continuation is the same as invoking the continuation with <code class="language-plaintext highlighter-rouge">reveal_rawexpr_cps</code> applied to the identity continuation.</li>
              <li>The next rule talks about a property we call <code class="language-plaintext highlighter-rouge">rawexpr_types_ok</code>.  To say that this property holds is to say that the <code class="language-plaintext highlighter-rouge">rawexper</code>s are well-typed in accordance with the unrevealed expressions stored in the tree.
                <ul>
                  <li>Code:
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="o">(</span><span class="no">r</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">rawexpr</span><span class="w"> </span><span class="no">var</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">r</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">alt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">s</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                  <li>We must then have that a <code class="language-plaintext highlighter-rouge">rawexpr</code> is <code class="language-plaintext highlighter-rouge">rawexpr_types_ok</code> if and only if the result of revealing one layer of structure via <code class="language-plaintext highlighter-rouge">reveal_rawexpr_cps</code> is <code class="language-plaintext highlighter-rouge">rawexpr_types_ok</code>.</li>
                </ul>
              </li>
              <li>We also define a relation <code class="language-plaintext highlighter-rouge">rawexpr_equiv</code> which says that two <code class="language-plaintext highlighter-rouge">rawexpr</code>s represent the same expression, up to different amounts of revealed structure.
                <ul>
                  <li>Code:
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="s2">"e1 === e2"</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type_scope</span><span class="pi">.</span><span class="w">

</span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">rawexpr_equiv_expr</span><span class="w"> </span><span class="o">{</span><span class="no">t0</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t0</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">r2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">struct</span><span class="w"> </span><span class="no">r2</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">r2</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">alt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="no">e1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">alt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="no">e1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f'</span><span class="w"> </span><span class="no">x'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">rawexpr_equiv_expr</span><span class="w"> </span><span class="no">f'</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">rawexpr_equiv_expr</span><span class="w"> </span><span class="no">x'</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="no">e1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">rawexpr_equiv</span><span class="w"> </span><span class="o">(</span><span class="no">r1</span><span class="w"> </span><span class="no">r2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">r1</span><span class="o">,</span><span class="w"> </span><span class="no">r2</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">,</span><span class="w"> </span><span class="no">r</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">r</span><span class="o">,</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="o">,</span><span class="w"> </span><span class="no">r</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">r</span><span class="o">,</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">rawexpr_equiv_expr</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">r</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">e1</span><span class="o">,</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">idc1</span><span class="w"> </span><span class="no">t'1</span><span class="w"> </span><span class="no">alt1</span><span class="o">,</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="no">idc2</span><span class="w"> </span><span class="no">t'2</span><span class="w"> </span><span class="no">alt2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">alt1</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="no">alt2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f1</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">alt1</span><span class="o">,</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f2</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="no">alt2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">alt1</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="no">alt2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">rawexpr_equiv</span><span class="w"> </span><span class="no">f1</span><span class="w"> </span><span class="no">f2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">rawexpr_equiv</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">x2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                  <li>The relation <code class="language-plaintext highlighter-rouge">rawexpr_equiv</code> is effectively the recursive closure of <code class="language-plaintext highlighter-rouge">reveal_rawexpr_cps</code>, and we must prove that <code class="language-plaintext highlighter-rouge">reveal_rawexpr e</code> and <code class="language-plaintext highlighter-rouge">e</code> are <code class="language-plaintext highlighter-rouge">rawexpr_equiv</code>.
&lt;!—</li>
                </ul>
              </li>
              <li>Finally, we define a notation of <code class="language-plaintext highlighter-rouge">wf</code> for <code class="language-plaintext highlighter-rouge">rawexpr</code>s called <code class="language-plaintext highlighter-rouge">wf_rawexpr</code>, and we prove that if two <code class="language-plaintext highlighter-rouge">rawexpr</code>s are <code class="language-plaintext highlighter-rouge">wf_rawexpr</code>-related, then the results of calling <code class="language-plaintext highlighter-rouge">reveal_rawexpr</code> on both of them are <code class="language-plaintext highlighter-rouge">wf_rawexpr</code>-related.
                <ul>
                  <li>The definition of <code class="language-plaintext highlighter-rouge">wf_rawexpr</code> is:
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Inductive</span><span class="w"> </span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">}%</span><span class="no">type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">},</span><span class="w"> </span><span class="o">@</span><span class="no">rawexpr</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">rawexpr</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Wf_rIdent</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">rIdent</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rIdent</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Wf_rApp</span><span class="w"> </span><span class="o">{</span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="o">}</span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">f1</span><span class="w"> </span><span class="o">(</span><span class="no">f1e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="o">(</span><span class="no">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">d</span><span class="o">))</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="o">(</span><span class="no">x1e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">s</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">f2</span><span class="w"> </span><span class="o">(</span><span class="no">f2e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="o">(</span><span class="no">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">d</span><span class="o">))</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="o">(</span><span class="no">x2e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">s</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">f1</span><span class="w"> </span><span class="no">f1e</span><span class="w"> </span><span class="no">f2</span><span class="w"> </span><span class="no">f2e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">x1e</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="no">x2e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rApp</span><span class="w"> </span><span class="no">f1</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">f1e</span><span class="w"> </span><span class="no">x1e</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">f1e</span><span class="w"> </span><span class="no">x1e</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rApp</span><span class="w"> </span><span class="no">f2</span><span class="w"> </span><span class="no">x2</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">f2e</span><span class="w"> </span><span class="no">x2e</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">f2e</span><span class="w"> </span><span class="no">x2e</span><span class="o">)</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Wf_rExpr</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">rExpr</span><span class="w"> </span><span class="no">e1</span><span class="o">)</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="o">(</span><span class="no">rExpr</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="o">|</span><span class="w"> </span><span class="no">Wf_rValue</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">rValue</span><span class="w"> </span><span class="no">v1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">reify</span><span class="w"> </span><span class="no">v1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rValue</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">reify</span><span class="w"> </span><span class="no">v2</span><span class="o">).</span><span class="w">
</span></code></pre></div>                    </div>
                    <p>—&gt;</p>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Evaluating the decision tree
    <ul>
      <li>Decision tree evaluation is performed by a single monolithic recursive function: <code class="language-plaintext highlighter-rouge">Fixpoint eval_decision_tree {T} (ctx : list rawexpr) (d : decision_tree) (cont : nat -&gt; list rawexpr -&gt; option T) {struct d} : option T</code>
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">eval_decision_tree</span><span class="w"> </span><span class="o">{</span><span class="no">T</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">ctx</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">d</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">cont</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">nat</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="no">rawexpr</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">struct</span><span class="w"> </span><span class="no">d</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">TryLeaf</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">onfailure</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">cont</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ctx</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">onfailure</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Failure</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">res</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="o">(@</span><span class="no">eval_decision_tree</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">ctx</span><span class="w"> </span><span class="no">onfailure</span><span class="w"> </span><span class="no">cont</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Failure</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Switch</span><span class="w"> </span><span class="no">icases</span><span class="w"> </span><span class="no">app_case</span><span class="w"> </span><span class="no">default_case</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">ctx</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">ctx0</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">ctx'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">res</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">reveal_rawexpr_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">ctx0</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">ctx0'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">ctx0'</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">alt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">fold_right</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="k">'</span><span class="o">(</span><span class="no">pidc</span><span class="o">,</span><span class="w"> </span><span class="no">icase</span><span class="o">)</span><span class="w"> </span><span class="no">rest</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">res</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="no">known</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">then</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">args</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">invert_bind_args</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">pidc</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">@</span><span class="no">eval_decision_tree</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">T</span><span class="w"> </span><span class="no">ctx'</span><span class="w"> </span><span class="no">icase</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ctx''</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">cont</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">rIdent</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">raw_pident_is_simple</span><span class="w"> </span><span class="no">pidc</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">raw_pident_to_typed</span><span class="w"> </span><span class="no">pidc</span><span class="w"> </span><span class="no">args</span><span class="o">)</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">ctx''</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">else</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">@</span><span class="no">eval_decision_tree</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">ctx'</span><span class="w"> </span><span class="no">icase</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ctx''</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">option_bind'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">invert_bind_args_unknown</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">pidc</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">args</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">cont</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">rIdent</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">raw_pident_is_simple</span><span class="w"> </span><span class="no">pidc</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">raw_pident_to_typed</span><span class="w"> </span><span class="no">pidc</span><span class="w"> </span><span class="no">args</span><span class="o">)</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">ctx''</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">match</span><span class="w"> </span><span class="no">rest</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">res</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">rest</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">res</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="no">rest</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">icases</span><span class="p">;;;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">alt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">app_case</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">app_case</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">eval_decision_tree</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">ctx'</span><span class="o">)</span><span class="w"> </span><span class="no">app_case</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ctx''</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">ctx''</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">f'</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">x'</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">ctx'''</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">cont</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">rApp</span><span class="w"> </span><span class="no">f'</span><span class="w"> </span><span class="no">x'</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="p">::</span><span class="w"> </span><span class="no">ctx'''</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="o">)</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">match</span><span class="w"> </span><span class="no">default_case</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Failure</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">res</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="p">;;</span><span class="w"> </span><span class="o">(@</span><span class="no">eval_decision_tree</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">ctx</span><span class="w"> </span><span class="no">default_case</span><span class="w"> </span><span class="no">cont</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Swap</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">d'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">swap_list</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">ctx</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">ctx'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">eval_decision_tree</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">T</span><span class="w"> </span><span class="no">ctx'</span><span class="w"> </span><span class="no">d'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ctx''</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">swap_list</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">ctx''</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">ctx'''</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">cont</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ctx'''</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>This function takes a list (vector in the original source paper) <code class="language-plaintext highlighter-rouge">ctx</code> of <code class="language-plaintext highlighter-rouge">rawexpr</code>s to match against, a <code class="language-plaintext highlighter-rouge">decision_tree</code> <code class="language-plaintext highlighter-rouge">d</code> to evaluate, and a “continuation” <code class="language-plaintext highlighter-rouge">cont</code> which tries a given rewrite rule based on the index of the rewrite rule (in the original list of rewrite rules) and the list of <code class="language-plaintext highlighter-rouge">rawexpr</code>s to feed into the rewrite rule.  This continuation is threaded through the decision tree evaluation procedure, and each time we split up the structure of the pattern matrix (virtually, in the decision tree) and the list of <code class="language-plaintext highlighter-rouge">rawexpr</code>s (concretely, as an argument), we add a bit to the continuation that “undoes” the splitting.  In the end, the top-level “continuation” gets fed a singleton list containing a <code class="language-plaintext highlighter-rouge">rawexpr</code> with enough structure for the rewrite rule it is trying.  TODO: Figure out how to be more clear here; I anticipate this is unclear, and I’m not sure how to fix it except by randomly throwing more sentences in to try to explain it in various different ways.</li>
      <li>Correctness conditions
        <ul>
          <li>There are two correctness conditions for <code class="language-plaintext highlighter-rouge">eval_decision_tree</code>: one for <code class="language-plaintext highlighter-rouge">wf</code>, and the other for <code class="language-plaintext highlighter-rouge">Interp</code>.
            <ul>
              <li>The interpretation-correctness rule says that either <code class="language-plaintext highlighter-rouge">eval_decision_tree</code> returns <code class="language-plaintext highlighter-rouge">None</code>, or it returns the result of calling the continuation on some index and with some list of <code class="language-plaintext highlighter-rouge">rawexpr</code>s which is element-wise <code class="language-plaintext highlighter-rouge">rawexpr_equiv</code> to the input list.  In other words, <code class="language-plaintext highlighter-rouge">eval_decision_tree</code> does nothing more than revealing some structure, and then eventually calling the continuation (which is to be filled in with “rewrite with this rule”) on the revealed <code class="language-plaintext highlighter-rouge">rawexpr</code>.</li>
            </ul>
          </li>
          <li>The <code class="language-plaintext highlighter-rouge">wf</code> correctness condition is significantly more verbose to state, but it boils down to saying that as long as the continuation behaves “the same” (for some parameterized notion of “the same”) on <code class="language-plaintext highlighter-rouge">wf_rawexpr</code>-related <code class="language-plaintext highlighter-rouge">rawexpr</code>s, then <code class="language-plaintext highlighter-rouge">eval_decision_tree</code> will similarly behave “the same” on element-wise <code class="language-plaintext highlighter-rouge">wf_rawexpr</code>-related lists of <code class="language-plaintext highlighter-rouge">rawexpr</code>s.
&lt;!—
            <ul>
              <li>TODO: Decide whether or not to include code:
                <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">wf_eval_decision_tree</span><span class="w"> </span><span class="o">{</span><span class="no">T1</span><span class="w"> </span><span class="no">T2</span><span class="o">}</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">(</span><span class="no">P</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">HPNone</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="no">None</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">(</span><span class="no">ctx1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">(@</span><span class="no">rawexpr</span><span class="w"> </span><span class="no">var1</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">ctx2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">(@</span><span class="no">rawexpr</span><span class="w"> </span><span class="no">var2</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">ctxe</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">}%</span><span class="no">type</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">Hctx1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">ctx1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">ctxe</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">Hctx2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">ctx2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">ctxe</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">Hwf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re1</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">re2</span><span class="w"> </span><span class="no">e2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">((</span><span class="no">re1</span><span class="o">,</span><span class="w"> </span><span class="no">re2</span><span class="o">),</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">e1</span><span class="o">,</span><span class="w"> </span><span class="no">e2</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="no">combine</span><span class="w"> </span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="no">combine</span><span class="w"> </span><span class="no">ctx1</span><span class="w"> </span><span class="no">ctx2</span><span class="o">)</span><span class="w"> </span><span class="no">ctxe</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re1</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">re2</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">cont1</span><span class="w"> </span><span class="no">cont2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">Hcont</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">ls1</span><span class="w"> </span><span class="no">ls2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">length</span><span class="w"> </span><span class="no">ls1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">ctxe</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">ls2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">ctxe</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re1</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">re2</span><span class="w"> </span><span class="no">e2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">((</span><span class="no">re1</span><span class="o">,</span><span class="w"> </span><span class="no">re2</span><span class="o">),</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">e1</span><span class="o">,</span><span class="w"> </span><span class="no">e2</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="no">combine</span><span class="w"> </span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="no">combine</span><span class="w"> </span><span class="no">ls1</span><span class="w"> </span><span class="no">ls2</span><span class="o">)</span><span class="w"> </span><span class="no">ctxe</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re1</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">re2</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">cont1</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">ls1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">&lt;-&gt;</span><span class="w"> </span><span class="no">cont2</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">ls2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">None</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="o">(</span><span class="no">cont1</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">ls1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">cont2</span><span class="w"> </span><span class="no">n</span><span class="w"> </span><span class="no">ls2</span><span class="o">)),</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="o">(@</span><span class="no">eval_decision_tree</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="no">ctx1</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">cont1</span><span class="o">)</span><span class="w"> </span><span class="o">(@</span><span class="no">eval_decision_tree</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="no">ctx2</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">cont2</span><span class="o">).</span><span class="w">
</span></code></pre></div>                </div>
                <p>—&gt;</p>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Definition
        <ul>
          <li>The <code class="language-plaintext highlighter-rouge">eval_decision_tree</code> procedure proceeds recursively on the structure of the <code class="language-plaintext highlighter-rouge">decision_tree</code>.
            <ul>
              <li>If the decision tree is a <code class="language-plaintext highlighter-rouge">TryLeaf k onfailure</code>, then we try the continuation on the <code class="language-plaintext highlighter-rouge">k</code>th rewrite rule.  If it fails (by returning <code class="language-plaintext highlighter-rouge">None</code>), we proceed with <code class="language-plaintext highlighter-rouge">onfailure</code>.  In the code, there is a bit of extra care taken to simplify the resulting output code when <code class="language-plaintext highlighter-rouge">onfailure</code> is just <code class="language-plaintext highlighter-rouge">Failure</code>, i.e., no remaining matches to try.  This probably does not impact performance, but it makes the output of the rewrite-rule-compilation procedure slightly easier to read and debug.</li>
              <li>If the decision tree is <code class="language-plaintext highlighter-rouge">Failure</code> return <code class="language-plaintext highlighter-rouge">None</code>, i.e., we did not succeed in rewriting.</li>
              <li>If the decision tree starts with <code class="language-plaintext highlighter-rouge">Swap i d'</code>, we swap the first element with the <code class="language-plaintext highlighter-rouge">i</code>th element in the list of <code class="language-plaintext highlighter-rouge">rawexpr</code>s we are matching on (to mirror the swapping in the pattern matrix that happened when compiling the decision tree), and then continue on evaluating <code class="language-plaintext highlighter-rouge">d'</code>.  We augment the continuation by reversing the swap in the list of <code class="language-plaintext highlighter-rouge">rawexpr</code>s passed in at the beginning, to cancel out the swap we did “on the outside” before continuing with evaluation of the decision tree.  Note that here we are jumping through some extra hoops to get the right reduction behavior at rewrite-rule-compilation time.</li>
              <li>If none of the above match, the decision tree must begin with <code class="language-plaintext highlighter-rouge">Switch icases app_case default_case</code>.  In this case, we start by revealing the structure of the first element of the list of <code class="language-plaintext highlighter-rouge">rawexpr</code>s.  (If there is no first element, which should never happen, we indicate failure by returning <code class="language-plaintext highlighter-rouge">None</code>.)  In the continuation of <code class="language-plaintext highlighter-rouge">reveal_rawexpr_cps</code>, we check which sort of <code class="language-plaintext highlighter-rouge">rawexpr</code> we have.  Note that in all cases of failure below, we try again with the <code class="language-plaintext highlighter-rouge">default_case</code>.
                <ul>
                  <li>If we have no accessible structure (<code class="language-plaintext highlighter-rouge">rExpr</code> or <code class="language-plaintext highlighter-rouge">rValue</code>), then we fail with <code class="language-plaintext highlighter-rouge">None</code>.</li>
                  <li>If we have an application, we take the two arguments of <code class="language-plaintext highlighter-rouge">rApp</code>, the function and its argument, and prepend them to the tail of the list of <code class="language-plaintext highlighter-rouge">rawexpr</code>s.  We then continue evaluation with <code class="language-plaintext highlighter-rouge">app_case</code> (if it is non-<code class="language-plaintext highlighter-rouge">None</code>), and, in the continuation, we reassemble the <code class="language-plaintext highlighter-rouge">rawexpr</code> by taking the first two elements of the passed-in-list, and combining them in a new <code class="language-plaintext highlighter-rouge">rApp</code> node.  We keep the unrevealed structure in <code class="language-plaintext highlighter-rouge">alt</code> the same as it was in the <code class="language-plaintext highlighter-rouge">rApp</code> that we started with.</li>
                  <li>If we have an identifier, then we look at <code class="language-plaintext highlighter-rouge">icases</code>.  We fold through the list of identifiers, looking to see if any of them match the identifier that we have.  If the identifier is <code class="language-plaintext highlighter-rouge">known</code>, then we perform the match before evaluating the corresponding decision tree, because we want to avoid revealing useless structure.  If the identifier is not <code class="language-plaintext highlighter-rouge">known</code>, then first we reveal all of the necessary structure for this identifier by continuing decision tree evaluation, and only then in the continuation do we try to match against the identifier.
                    <ul>
                      <li>In both cases, we drop the first element of the list of <code class="language-plaintext highlighter-rouge">rawexpr</code>s being matched against when continuing evaluation, to mirror the dropping that happens in compilation of the decision tree.  We then prepend a re-built identifier onto the head of the list inside the continuation.  We have a table of which pattern identifiers have <code class="language-plaintext highlighter-rouge">known</code> types, and we have conversion functions between pattern identifiers and PHOAST identifiers (autogenerated in Python) which allow us to extract the arguments from the PHOAST identifier and re-insert them into the pattern identifier.  For example, this will extract the list type from <code class="language-plaintext highlighter-rouge">nil</code> (because the pattern-identifier version does not specify what the type of the list is—we will say more about this in the next section), or the literal value from the <code class="language-plaintext highlighter-rouge">Literal</code> identifier, and allow recreating the fully-typed identifier from the pattern-identifier with these arguments.  This allows more rewriter-compile-time reduction opportunities which allows us to deduplicate matches against the same identifier.  Note that we have two different constants that we use for binding these arguments; they do the same thing, but one is reduced away completely at rewrite-rule-compilation time, and the other is preserved.</li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="rewriting-with-a-particular-rewrite-rule">Rewriting with a particular rewrite rule</h3>
<ul>
  <li>The final big piece of the rewriter is to rewrite with a particular rule, given a <code class="language-plaintext highlighter-rouge">rawexpr</code> with enough revealed structure, a <code class="language-plaintext highlighter-rouge">pattern</code> against which we bind arguments, and a replacement rule which is a function indexed over the <code class="language-plaintext highlighter-rouge">pattern</code>.  We saw above the inductive type of patterns.  Let us now discuss the structure of the replacement rules.</li>
  <li>Replacement rule types
    <ul>
      <li>The data for a replacement rule is indexed over a pattern-type <code class="language-plaintext highlighter-rouge">t</code> and a <code class="language-plaintext highlighter-rouge">p : pattern t</code>.  It has three options, in addition to the actual replacement rule:
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Record</span><span class="w"> </span><span class="no">rewrite_rule_data</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">rew_should_do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">rew_with_opt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">rew_under_lets</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">rew_replacement</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">with_unif_rewrite_ruleTP_gen</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">rew_should_do_again</span><span class="w"> </span><span class="no">rew_with_opt</span><span class="w"> </span><span class="no">rew_under_lets</span><span class="w"> </span><span class="o">}.</span><span class="w">
</span></code></pre></div>        </div>
        <ul>
          <li><code class="language-plaintext highlighter-rouge">rew_should_do_again</code> determines whether or not to rewrite again in the output of this rewrite rule.  For example, the rewrite rule for <code class="language-plaintext highlighter-rouge">flat_map</code> on a concrete list of cons cells maps the function over the list, and joins the resulting list of lists with append.  We want to rewrite again with the rule for <code class="language-plaintext highlighter-rouge">List.app</code> in the output of this replacement.</li>
          <li><code class="language-plaintext highlighter-rouge">rew_with_opt</code> determines whether or not the rewrite rule might fail.  For example, rewrite rules like <code class="language-plaintext highlighter-rouge">x + 0 ~&gt; x</code> are encoded by talking about the pattern of a wildcard added to a literal, and say that the rewrite only succeeds if the literal is 0.  Additionally, as another example, all rewrite rules involving casts fail if bounds on the input do not line up; in the pattern <code class="language-plaintext highlighter-rouge">Z.cast @ ((Z.cast @ ??) + (Z.cast @ ??))</code> the cast node in front of an addition must be loose enough to hold the sum of the ranges taken from the two cast nodes in front of each of the wildcards.</li>
          <li><code class="language-plaintext highlighter-rouge">rew_under_lets</code> determines whether or not the replacement rule returns an explicit <code class="language-plaintext highlighter-rouge">UnderLets</code> structure.  This can be used for let-binding a part of the replacement value.</li>
        </ul>
      </li>
      <li>The rewrite rule replacement itself is a function.  It takes in first all type variables which are mentioned in the pattern, and then, in an in-order traversal of the pattern syntax tree, the non-type arguments for each identifier (e.g., interpreted values of literals, ranges of cast nodes) and a <code class="language-plaintext highlighter-rouge">value (pattern.type.subst_default t evm)</code> for each wildcard of type <code class="language-plaintext highlighter-rouge">t</code> (that is, we plug in the known type variables into the pattern-type, and use <code class="language-plaintext highlighter-rouge">unit</code> for any unknown type variables).  It may return a thing in the <code class="language-plaintext highlighter-rouge">option</code> and/or <code class="language-plaintext highlighter-rouge">UnderLets</code> monads, depending on <code class="language-plaintext highlighter-rouge">rew_with_opt</code> and <code class="language-plaintext highlighter-rouge">rew_under_lets</code>.  Underneath these possible monads, it returns an <code class="language-plaintext highlighter-rouge">expr</code> of the correct type (we substitute the type variables we take in into the type of the pattern), whose <code class="language-plaintext highlighter-rouge">var</code> type is either <code class="language-plaintext highlighter-rouge">@value var</code> (if <code class="language-plaintext highlighter-rouge">rew_should_do_again</code>) or <code class="language-plaintext highlighter-rouge">var</code> (if not <code class="language-plaintext highlighter-rouge">rew_should_do_again</code>).  The different <code class="language-plaintext highlighter-rouge">var</code> types are primarily to make the type of the output of the rewrite rule line up with the expression type that is fed into the rewriter as a whole.  We have a number of definitions that describe this in a dependently typed mess:
        <ul>
          <li>We aggregate the type variables into a <code class="language-plaintext highlighter-rouge">PositiveSet.t</code> with <code class="language-plaintext highlighter-rouge">Fixpoint pattern.base.collect_vars (t : base.type) : PositiveSet.t</code> and <code class="language-plaintext highlighter-rouge">Fixpoint pattern.type.collect_vars (t : type) : PositiveSet.t</code>:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Module</span><span class="w"> </span><span class="no">base</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">collect_vars</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">var</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">empty</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">type_base</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">empty</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">prod</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">union</span><span class="w"> </span><span class="o">(</span><span class="no">collect_vars</span><span class="w"> </span><span class="no">A</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">collect_vars</span><span class="w"> </span><span class="no">B</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">list</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">collect_vars</span><span class="w"> </span><span class="no">A</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">base</span><span class="pi">.</span><span class="w">
</span><span class="k">Module</span><span class="w"> </span><span class="no">type</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">collect_vars</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">collect_vars</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">union</span><span class="w"> </span><span class="o">(</span><span class="no">collect_vars</span><span class="w"> </span><span class="no">s</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">collect_vars</span><span class="w"> </span><span class="no">d</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">type</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>We quantify over type variables for each of the numbers in the <code class="language-plaintext highlighter-rouge">PositiveSet.t</code> and aggregate the bound types into a <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> with <code class="language-plaintext highlighter-rouge">pattern.type.forall_vars</code>.  Note that we use the possibly ill-chosen abbreviation <code class="language-plaintext highlighter-rouge">EvarMap</code> for <code class="language-plaintext highlighter-rouge">PositiveMap.t Compilers.base.type</code>.
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">forall_vars_body</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="no">LS</span><span class="w"> </span><span class="no">EVM0</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">K</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">LS</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">EVM0</span><span class="o">).</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">forall_vars</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">k</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">forall_vars_body</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="no">rev</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">elements</span><span class="w"> </span><span class="no">p</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">empty</span><span class="w"> </span><span class="p">_</span><span class="o">).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>We take in the context variable <code class="language-plaintext highlighter-rouge">pident_arg_types : forall t, pident t -&gt; list Type</code> which describes the arguments bound for a given pattern identifier.</li>
          <li>We then quantify over identifier arguments and wildcard values with <code class="language-plaintext highlighter-rouge">with_unification_resultT</code>:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">type_of_list_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">K</span><span class="o">)).</span><span class="w">

</span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">with_unification_resultT'</span><span class="w"> </span><span class="o">{</span><span class="no">var</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">K</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">Type</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Wildcard</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">K</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">type_of_list_cps</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="o">(</span><span class="no">pident_arg_types</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">with_unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">(@</span><span class="no">with_unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">K</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">type</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">with_unification_resultT</span><span class="w"> </span><span class="o">{</span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">K</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">forall_vars</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(@</span><span class="nn">pattern</span><span class="p">.</span><span class="no">collect_vars</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">with_unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">(</span><span class="no">K</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">))).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>Finally, we can define the type of rewrite replacement rules:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen'</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="no">with_opt</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="kr">match</span><span class="w"> </span><span class="o">(@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">var</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="no">x0</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">x0</span><span class="o">)</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="no">with_opt</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">x1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="o">).</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen</span><span class="w"> </span><span class="o">(</span><span class="no">should_do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">with_opt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">under_lets</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen'</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="no">with_opt</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="no">t</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">with_unif_rewrite_ruleTP_gen</span><span class="w"> </span><span class="o">{</span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">should_do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">with_opt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">under_lets</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">with_unification_resultT</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen'</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="no">with_opt</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="no">t</span><span class="o">).</span><span class="w">
</span></code></pre></div>            </div>
            <p>Whence we have</p>
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">rew_replacement</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">with_unif_rewrite_ruleTP_gen</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">rew_should_do_again</span><span class="w"> </span><span class="no">rew_with_opt</span><span class="w"> </span><span class="no">rew_under_lets</span><span class="w">
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>There are two steps to rewriting with a rule, both conceptually simple but in practice complicated by dependent types.  We must unify a pattern with an expression, gathering binding data for the replacement rule as we go; and we must apply the replacement rule to the binding data (which is non-trivial because the rewrite rules are expressed as curried dependently-typed towers indexed over the rewrite rule pattern).  In order to state the correctness conditions for gathering binding data, we must first talk about applying replacement rules to binding data.</li>
  <li>Applying binding data
    <ul>
      <li>The general strategy for applying binding data is to define an uncurried package (sigma type, or dependent pair) holding all of the arguments, and to define an application function that applies the replacement rule (at various stages of construction) to the binding data package.</li>
      <li>The uncurried package types
        <ul>
          <li>To turn a list of Types into a Type, we define <code class="language-plaintext highlighter-rouge">Local Notation type_of_list := (fold_right (fun a b =&gt; prod a b) unit)</code>.</li>
          <li>The type <code class="language-plaintext highlighter-rouge">unification_resultT'</code> describes the binding data for a pattern, given a map of pattern type variables to types:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">unification_resultT'</span><span class="w"> </span><span class="o">{</span><span class="no">var</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">Type</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Wildcard</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">type_of_list</span><span class="w"> </span><span class="o">(</span><span class="no">pident_arg_types</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">type</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>A <code class="language-plaintext highlighter-rouge">unification_resultT</code> packages up the type variable replacement map with the bound values:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">unification_resultT</span><span class="w"> </span><span class="o">{</span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">}.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>The application functions
        <ul>
          <li>The definition <code class="language-plaintext highlighter-rouge">app_type_of_list</code> applies a CPS-type <code class="language-plaintext highlighter-rouge">type_of_list_cps</code> function to uncurried arguments:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">app_type_of_list</span><span class="w"> </span><span class="o">{</span><span class="no">K</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">ls</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type_of_list_cps</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="no">ls</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">args</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type_of_list</span><span class="w"> </span><span class="no">ls</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">K</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">list_rect</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">ls</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">type_of_list_cps</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">type_of_list</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">K</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">Ts</span><span class="w"> </span><span class="no">rec</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">rec</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="o">(</span><span class="no">fst</span><span class="w"> </span><span class="no">x</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="no">snd</span><span class="w"> </span><span class="no">x</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">ls</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">f</span><span class="w"> </span><span class="no">args</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>Given two different maps of type variables (another instance of abstraction-barrier-breaking), we can apply a <code class="language-plaintext highlighter-rouge">with_unification_resultT'</code> to a <code class="language-plaintext highlighter-rouge">unification_resultT'</code> by inserting casts in the appropriate places:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">(** TODO: Maybe have a fancier version of this that doesn't
     actually need to insert casts, by doing a fixpoint on the
     list of elements / the evar map *)</span><span class="w">
</span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">app_transport_with_unification_resultT'_cps</span><span class="w"> </span><span class="o">{</span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm1</span><span class="w"> </span><span class="no">evm2</span><span class="w"> </span><span class="no">K</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">struct</span><span class="w"> </span><span class="no">p</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">with_unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm1</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">T</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">K</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="no">with_unification_resultT'</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm1</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Wildcard</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">tr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">try_make_transport_cps</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">try_make_transport_cps</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">tr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">tr</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="o">(</span><span class="no">tr</span><span class="w"> </span><span class="no">x</span><span class="o">)))%</span><span class="no">option</span><span class="o">)%</span><span class="no">cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">app_type_of_list</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">F</span><span class="w"> </span><span class="o">(</span><span class="no">xy</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">app_transport_with_unification_resultT'_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">F</span><span class="w"> </span><span class="o">(</span><span class="no">fst</span><span class="w"> </span><span class="no">xy</span><span class="o">)</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">F'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">app_transport_with_unification_resultT'_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">F'</span><span class="w"> </span><span class="o">(</span><span class="no">snd</span><span class="w"> </span><span class="no">xy</span><span class="o">)</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">x'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">x'</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">option</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>We can apply a <code class="language-plaintext highlighter-rouge">forall_vars</code> tower over the type variables in a pattern to a particular mapping of type variables to types, with a headache of dependently typed code:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">app_forall_vars_gen</span><span class="w"> </span><span class="o">{</span><span class="no">k</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">ls</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">key</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">evm0</span><span class="o">,</span><span class="w"> </span><span class="no">forall_vars_body</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="no">evm0</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="kr">match</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">find</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="kr">end</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">ls</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">evm0</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">evm0</span><span class="o">,</span><span class="w"> </span><span class="no">forall_vars_body</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="no">evm0</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="kr">match</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">find</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="kr">end</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">ls</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">evm0</span><span class="o">))</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">evm0</span><span class="w"> </span><span class="no">val</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">val</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">cons</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">xs</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">find</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="no">xt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">evm0</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">fold_right</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">xs</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm0</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">xs</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">match</span><span class="w"> </span><span class="no">xt</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">evm0</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm0</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">evm0</span><span class="w"> </span><span class="no">val</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">app_forall_vars_gen</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">xs</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="no">val</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">evm0</span><span class="w"> </span><span class="no">val</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">app_forall_vars</span><span class="w"> </span><span class="o">{</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">k</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">forall_vars</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">k</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="kr">match</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">find</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="kr">end</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="no">rev</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">elements</span><span class="w"> </span><span class="no">p</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">empty</span><span class="w"> </span><span class="p">_</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">app_forall_vars_gen</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="no">rev</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">elements</span><span class="w"> </span><span class="no">p</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">empty</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">f</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>Finally, we can apply a <code class="language-plaintext highlighter-rouge">with_unification_resultT</code> to a <code class="language-plaintext highlighter-rouge">unification_resultT</code> package in the obvious way, inserting casts as needed:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">app_with_unification_resultT_cps</span><span class="w"> </span><span class="o">{</span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">K</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">with_unification_resultT</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">T</span><span class="o">,</span><span class="w"> </span><span class="o">({</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm'</span><span class="o">)</span><span class="w"> </span><span class="o">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">f'</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">app_forall_vars</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="o">(</span><span class="no">projT1</span><span class="w"> </span><span class="no">x</span><span class="o">)</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">app_transport_with_unification_resultT'_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">f'</span><span class="w"> </span><span class="o">(</span><span class="no">projT2</span><span class="w"> </span><span class="no">x</span><span class="o">)</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">fx</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">fx</span><span class="o">)))%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Unifying patterns with expressions
    <ul>
      <li>First, we unify the types, in continuation-passing-style, returning an optional <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> from type variable indices to types.
        <ul>
          <li>This is actually done in two steps, so that rewrite-rule-compilation can reduce away all occurrences of patterns.  First, we check that the expression has the right structure, and extract all of the relevant types both from the pattern and from the expression.  Then we connect the types with <code class="language-plaintext highlighter-rouge">type.arrow</code> (used simply for convenience, so we don’t have to unify lists of types, only individual types), and we unify the two resulting types, extracting a <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> describing the assignments resulting from the unification problem.
            <ul>
              <li>We first define a few helper definitions that should be self-explanatory:
                <ul>
                  <li>The function <code class="language-plaintext highlighter-rouge">type_of_rawexpr</code> gets the type of a <code class="language-plaintext highlighter-rouge">rawexpr</code>:
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                  <li>The functions <code class="language-plaintext highlighter-rouge">pattern.base.relax</code> and <code class="language-plaintext highlighter-rouge">pattern.type.relax</code> take a PHOAST type and turn it into a pattern type, which just happens to have no pattern type variables.
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Module</span><span class="w"> </span><span class="no">base</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">relax</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">type_base</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">type_base</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">prod</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">prod</span><span class="w"> </span><span class="o">(</span><span class="no">relax</span><span class="w"> </span><span class="no">A</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">relax</span><span class="w"> </span><span class="no">B</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">list</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">list</span><span class="w"> </span><span class="o">(</span><span class="no">relax</span><span class="w"> </span><span class="no">A</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">base</span><span class="pi">.</span><span class="w">
</span><span class="k">Module</span><span class="w"> </span><span class="no">type</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">relax</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="o">(</span><span class="nn">base</span><span class="p">.</span><span class="no">relax</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="o">(</span><span class="no">relax</span><span class="w"> </span><span class="no">s</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">relax</span><span class="w"> </span><span class="no">d</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">type</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                </ul>
              </li>
              <li>The function responsible for checking the structure of patterns and extracting the types to be unified is <code class="language-plaintext highlighter-rouge">preunify_types {t} (e : rawexpr) (p : pattern t) :  option (option (ptype * type))</code>.  It will return <code class="language-plaintext highlighter-rouge">None</code> if the structure does not match, <code class="language-plaintext highlighter-rouge">Some None</code> if the type of an identifier of known type in the <code class="language-plaintext highlighter-rouge">rawexpr</code> does not match the type of the identifier in the pattern (which is guaranteed to always be known, and thus this comparison is safe to perform at rewriter-rule-compilation time), and will return <code class="language-plaintext highlighter-rouge">Some (Some (t1, t2))</code> if the structures match, where <code class="language-plaintext highlighter-rouge">t1</code> and <code class="language-plaintext highlighter-rouge">t2</code> are the types to be unified.
                <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">preunify_types</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">struct</span><span class="w"> </span><span class="no">p</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">ptype</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">type</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">p</span><span class="o">,</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Wildcard</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">pt</span><span class="w"> </span><span class="no">pidc</span><span class="o">,</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="no">andb</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">type_beq</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">type_beq</span><span class="w"> </span><span class="no">pt</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">relax</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w"> </span><span class="c">(* relies on evaluating to `false` if `known` is `false` *)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">pt</span><span class="o">,</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">pf</span><span class="w"> </span><span class="no">px</span><span class="o">,</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">resa</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">@</span><span class="no">preunify_types</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">pf</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">resb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="o">@</span><span class="no">preunify_types</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">px</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">Some</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">resa</span><span class="o">,</span><span class="w"> </span><span class="no">resb</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="o">,</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="o">,</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">a</span><span class="o">,</span><span class="w"> </span><span class="no">a'</span><span class="o">),</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">b</span><span class="o">,</span><span class="w"> </span><span class="no">b'</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">b</span><span class="o">,</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">a'</span><span class="w"> </span><span class="no">b'</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                </div>
              </li>
              <li>We have two correctness conditions on <code class="language-plaintext highlighter-rouge">preunify_types</code>.
                <ul>
                  <li>The <code class="language-plaintext highlighter-rouge">wf</code> correctness condition says that if two <code class="language-plaintext highlighter-rouge">rawexpr</code>s are <code class="language-plaintext highlighter-rouge">wf_rawexpr</code>-related, then the result of pre-unifying one of them with a pattern <code class="language-plaintext highlighter-rouge">p</code> is the same as the result of pre-unifying the other with the same pattern <code class="language-plaintext highlighter-rouge">p</code>.</li>
                  <li>Second, for interpretation-correctness, we define a recursive proposition encoding the well-matching of patterns with <code class="language-plaintext highlighter-rouge">rawexpr</code>s under a given map of pattern type variables to types:
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">types_match_with</span><span class="w"> </span><span class="o">(</span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">struct</span><span class="w"> </span><span class="no">p</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">p</span><span class="o">,</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Wildcard</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="o">,</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">t'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="o">,</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f'</span><span class="w"> </span><span class="no">x'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">types_match_with</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f'</span><span class="w"> </span><span class="no">f</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="o">@</span><span class="no">types_match_with</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x'</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                  <li>Then we prove that for any map <code class="language-plaintext highlighter-rouge">evm</code> of pattern type variables to types, if <code class="language-plaintext highlighter-rouge">preunify_types re p</code> returns <code class="language-plaintext highlighter-rouge">Some (Some (pt, t'))</code>, and the result of substituting into <code class="language-plaintext highlighter-rouge">pt</code> the pattern type variables in the given map is <code class="language-plaintext highlighter-rouge">t'</code>, then <code class="language-plaintext highlighter-rouge">types_match_with evm re p</code> holds.  Symbolically, this is
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">preunify_types_to_match_with</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="o">@</span><span class="no">preunify_types</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">pident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">True</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">pt</span><span class="o">,</span><span class="w"> </span><span class="no">t'</span><span class="o">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst</span><span class="w"> </span><span class="no">pt</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">t'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">types_match_with</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">p</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                </ul>
              </li>
              <li>In a possibly-gratuitous use of dependent typing to ensure that no uses of <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> remain after rewrite-rule-compilation, we define a dependently typed data structure indexed over the pattern type which holds the mapping of each pattern type variable to a corresponding type.  This step cannot be fully reduced at rewrite-rule-compilation time, because we may not know enough type structure in the <code class="language-plaintext highlighter-rouge">rawexpr</code>.  We then collect these variables into a <code class="language-plaintext highlighter-rouge">PositiveMap.t</code>; this step <em>can</em> be fully reduced at rewrite-rule-compilation time, because the pattern always has a well-defined type structure, and so we know <em>which</em> type variables will have assignments in the <code class="language-plaintext highlighter-rouge">PositiveMap.t</code>, even if we don’t necessarily know concretely (at rewrite-rule-compilation time) <em>what</em> those type variables will be assigned to.  We must also add a final check that substituting into the pattern type according the resulting <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> actually does give the expected type; we do not want <code class="language-plaintext highlighter-rouge">'1 -&gt; '1</code> and <code class="language-plaintext highlighter-rouge">nat -&gt; bool</code> to unify.  We could check at each addition to the <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> that we are not replacing one type with a different type.  However, the proofs are much simpler if we simply do a wholesale check at the very end.  We eventually perform this check in <code class="language-plaintext highlighter-rouge">unify_types</code>.
                <ul>
                  <li>We thus define the dependently typed structures:
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Module</span><span class="w"> </span><span class="no">base</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Set</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">var</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">type_base</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">unit</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">prod</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">B</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">list</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">A</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">type</span><span class="pi">.</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">add_var_types_cps</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">v</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">~&gt;</span><span class="w"> </span><span class="no">EvarMap</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">var</span><span class="w"> </span><span class="no">p</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">prod</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="k">'</span><span class="o">(</span><span class="no">a</span><span class="o">,</span><span class="w"> </span><span class="no">b</span><span class="o">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">add_var_types_cps</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">add_var_types_cps</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="no">b</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">k</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">list</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">add_var_types_cps</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">type_base</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="no">v</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">base</span><span class="pi">.</span><span class="w">
</span><span class="k">Module</span><span class="w"> </span><span class="no">type</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Set</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">var_types_of</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">d</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">type</span><span class="pi">.</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">add_var_types_cps</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">v</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">~&gt;</span><span class="w"> </span><span class="no">EvarMap</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="no">var_types_of</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="nn">base</span><span class="p">.</span><span class="no">add_var_types_cps</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="k">'</span><span class="o">(</span><span class="no">a</span><span class="o">,</span><span class="w"> </span><span class="no">b</span><span class="o">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">add_var_types_cps</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">add_var_types_cps</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="no">b</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">k</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w"> </span><span class="no">v</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">type</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                  <li>We can now write down the unifier that produces <code class="language-plaintext highlighter-rouge">var_types_of</code> from a unification problem; it is straightforward:
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Module</span><span class="w"> </span><span class="no">base</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">unify_extracted</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">ptype</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">etype</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">var_types_of</span><span class="w"> </span><span class="no">ptype</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">ptype</span><span class="o">,</span><span class="w"> </span><span class="no">etype</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">var_types_of</span><span class="w"> </span><span class="no">ptype</span><span class="o">)</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">var</span><span class="w"> </span><span class="no">p</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">etype</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">type_base</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">type_base</span><span class="w"> </span><span class="no">t'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">base_beq</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">t'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">tt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">prod</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="o">,</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">prod</span><span class="w"> </span><span class="no">A'</span><span class="w"> </span><span class="no">B'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">unify_extracted</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">A'</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">unify_extracted</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="no">B'</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">a</span><span class="o">,</span><span class="w"> </span><span class="no">b</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">list</span><span class="w"> </span><span class="no">A</span><span class="o">,</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">list</span><span class="w"> </span><span class="no">A'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">unify_extracted</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">A'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">type_base</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">prod</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">list</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">base</span><span class="pi">.</span><span class="w">
</span><span class="k">Module</span><span class="w"> </span><span class="no">type</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">unify_extracted</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">ptype</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">etype</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="nn">Compilers</span><span class="p">.</span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">var_types_of</span><span class="w"> </span><span class="no">ptype</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">ptype</span><span class="o">,</span><span class="w"> </span><span class="no">etype</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">var_types_of</span><span class="w"> </span><span class="no">ptype</span><span class="o">)</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">unify_extracted</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">t'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="o">,</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">A'</span><span class="w"> </span><span class="no">B'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">unify_extracted</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">A'</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">b</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">unify_extracted</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="no">B'</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">a</span><span class="o">,</span><span class="w"> </span><span class="no">b</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">type</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                </ul>
              </li>
              <li>Finally, we can write down the type-unifier for patterns and <code class="language-plaintext highlighter-rouge">rawexpr</code>s.  Note that the final equality check, described and motivated above, is performed in this function.
                <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">(* for unfolding help *)</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">option_type_type_beq</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">option_beq</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">type_beq</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">type_beq</span><span class="o">).</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">unify_types</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">~&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">EvarMap</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">preunify_types</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">pt</span><span class="o">,</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">unify_extracted</span><span class="w"> </span><span class="no">pt</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">vars</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">add_var_types_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">vars</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">empty</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="c">(* there might be multiple type variables which map to incompatible types; we check for that here *)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">if</span><span class="w"> </span><span class="no">option_type_type_beq</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst</span><span class="w"> </span><span class="no">pt</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">then</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">else</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">None</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">empty</span><span class="w"> </span><span class="p">_</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                </div>
              </li>
            </ul>
          </li>
        </ul>
      </li>
      <li>Now that we have unified the types and gotten a <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> of pattern type variables to types, we are ready to unify the patterns, and extract the identifier arguments and <code class="language-plaintext highlighter-rouge">value</code>s from the <code class="language-plaintext highlighter-rouge">rawexpr</code>.  Because it would be entirely too painful to track at the type-level that the type unifier guarantees a match on structure and types, we instead sprinkle type transports all over this definition to get the types to line up.  Here we pay the price of an imperfect abstraction barrier (that we have types lying around, and we rely in some places on types lining up, but do not track everywhere that types line up).  Most of the other complications in this function come from (a) working in continuation-passing-style (for getting the right reduction behavior) or (b) tracking the differences between things we can reduce at rewrite-rule-compilation time, and things we can’t.
        <ul>
          <li>We first describe some helper definitions and context variables.
            <ul>
              <li>The context variable <code class="language-plaintext highlighter-rouge">pident_arg_types : forall t, pident t -&gt; list Type</code> describes for each pattern identifier what arguments should be bound for it.</li>
              <li>The context variables <code class="language-plaintext highlighter-rouge">(pident_unify pident_unify_unknown : forall t t' (idc : pident t) (idc' : ident t'), option (type_of_list (pident_arg_types t idc)))</code> are the to-be-unfolded and not-to-be-unfolded versions of unifying a pattern identifier with a PHOAST identifier.</li>
              <li>We can convert a <code class="language-plaintext highlighter-rouge">rawexpr</code> into a <code class="language-plaintext highlighter-rouge">value</code> or an <code class="language-plaintext highlighter-rouge">expr</code>:
                <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">expr_of_rawexpr</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">alt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">alt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">reify</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">value_of_rawexpr</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="k">Eval</span><span class="w"> </span><span class="kp">cbv</span><span class="w"> </span><span class="err">`</span><span class="no">expr_of_rawexpr</span><span class="err">`</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">reflect</span><span class="w"> </span><span class="o">(</span><span class="no">expr_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                </div>
              </li>
            </ul>
          </li>
          <li>We can now write down the pattern-expression-unifier:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">option_bind'</span><span class="w"> </span><span class="o">{</span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="nn">Option</span><span class="p">.</span><span class="no">bind</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="pi">.</span><span class="w"> </span><span class="c">(* for help with unfolding *)</span><span class="w">

</span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">unify_pattern'</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">struct</span><span class="w"> </span><span class="no">p</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">T</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">p</span><span class="o">,</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">T</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Wildcard</span><span class="w"> </span><span class="no">t'</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">tro</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">try_make_transport_cps</span><span class="w"> </span><span class="o">(@</span><span class="nn">base</span><span class="p">.</span><span class="no">try_make_transport_cps</span><span class="o">)</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">tr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">tro</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">_</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">evm</span><span class="p">;</span><span class="w"> </span><span class="c">(* ensure that we did not fall into the default case *)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">tr</span><span class="w"> </span><span class="o">(</span><span class="no">value_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">))))%</span><span class="no">option</span><span class="o">)%</span><span class="no">cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">pidc</span><span class="o">,</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="no">known</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">known</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="nn">Option</span><span class="p">.</span><span class="no">bind</span><span class="w"> </span><span class="o">(</span><span class="no">pident_unify</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">pidc</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">option_bind'</span><span class="w"> </span><span class="o">(</span><span class="no">pident_unify_unknown</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">pidc</span><span class="w"> </span><span class="no">idc</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">pf</span><span class="w"> </span><span class="no">px</span><span class="o">,</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unify_pattern'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">_</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">pf</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">fv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unify_pattern'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">px</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">xv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">fv</span><span class="o">,</span><span class="w"> </span><span class="no">xv</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
            <ul>
              <li>We have three correctness conditions on <code class="language-plaintext highlighter-rouge">unify_pattern'</code>:
                <ul>
                  <li>It must be the case that if we invoke <code class="language-plaintext highlighter-rouge">unify_pattern'</code> with any continuation, the result is the same as invoking it with the continuation <code class="language-plaintext highlighter-rouge">Some</code>, binding the result in the option monad, and then invoking the continuation on the bound value.</li>
                  <li>There is the <code class="language-plaintext highlighter-rouge">wf</code> correctness condition, which says that if two <code class="language-plaintext highlighter-rouge">rawexpr</code>s are <code class="language-plaintext highlighter-rouge">wf_rawexpr</code>-related, then invoking <code class="language-plaintext highlighter-rouge">unify_pattern'</code> with the continuation <code class="language-plaintext highlighter-rouge">Some</code> either results in <code class="language-plaintext highlighter-rouge">None</code> on both of them, or it results in two <code class="language-plaintext highlighter-rouge">wf_unification_resultT'</code>-related results.  We define <code class="language-plaintext highlighter-rouge">wf_unification_resultT'</code> as
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">wf_value'</span><span class="w"> </span><span class="o">{</span><span class="no">with_lets</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">}</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value'1</span><span class="w"> </span><span class="no">with_lets</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value'2</span><span class="w"> </span><span class="no">with_lets</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">with_lets</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G'</span><span class="o">)</span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">f1</span><span class="w"> </span><span class="no">f2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">seg</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">G'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">seg</span><span class="w"> </span><span class="o">++</span><span class="w"> </span><span class="no">G</span><span class="o">)%</span><span class="no">list</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">wf_value'</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="no">seg</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">wf_value'</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">(</span><span class="no">f1</span><span class="w"> </span><span class="no">v1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">f2</span><span class="w"> </span><span class="no">v2</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">wf_value'</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="pi">.</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">wf_value_with_lets</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value_with_lets1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value_with_lets2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">wf_value'</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="pi">.</span><span class="w">

</span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">related_unification_resultT'</span><span class="w"> </span><span class="o">{</span><span class="no">var1</span><span class="w"> </span><span class="no">var2</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Wildcard</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">eq</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="o">(</span><span class="no">v1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">v2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">related_unification_resultT'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="no">fst</span><span class="w"> </span><span class="no">v1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">fst</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">/\</span><span class="w"> </span><span class="o">@</span><span class="no">related_unification_resultT'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="no">snd</span><span class="w"> </span><span class="no">v1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">snd</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">wf_unification_resultT'</span><span class="w"> </span><span class="o">(</span><span class="no">G</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="no">t1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">(</span><span class="no">var1</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t1</span><span class="o">)%</span><span class="no">type</span><span class="o">})</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">related_unification_resultT'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                  <li>The interp-correctness condition is (a bit more than) a bit of a mouthful, and requires some auxiliary definitions.
                    <ul>
                      <li>It is a bit hard to say what makes an expression interp-related to an interpreted value.  Under the assumption of function extensionality, an expression is interp-related to a interpreted value if and only if the interpretation of the expression is equal to the interpreted value.  Thus <code class="language-plaintext highlighter-rouge">expr.interp_related</code> is an attempt to avoid function extensionality that is not fully successful, likely because I cannot say in words what exactly it is supposed to mean.  The definition is
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Section</span><span class="w"> </span><span class="no">with_interp</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Context</span><span class="w"> </span><span class="o">{</span><span class="no">base_type</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">ident</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="no">base_type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">interp_base_type</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">base_type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">interp_ident</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">interp_base_type</span><span class="w"> </span><span class="no">t</span><span class="o">).</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">interp_related_gen</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">var</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="no">base_type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">interp_base_type</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">base_type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">interp_base_type</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">interp_base_type</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">Var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kp">exists</span><span class="w"> </span><span class="no">fv</span><span class="w"> </span><span class="no">xv</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">@</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">fv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="o">@</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">xv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">fv</span><span class="w"> </span><span class="no">xv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">v2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">interp_ident</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">Abs</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">f2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">x2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">x2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">(</span><span class="no">f1</span><span class="w"> </span><span class="no">x1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">f2</span><span class="w"> </span><span class="no">x2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">LetIn</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="c">(* combine the App rule with the Abs rule *)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kp">exists</span><span class="w"> </span><span class="no">fv</span><span class="w"> </span><span class="no">xv</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">@</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">xv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">x2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">x2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="no">x1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">fv</span><span class="w"> </span><span class="no">x2</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">fv</span><span class="w"> </span><span class="no">xv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Definition</span><span class="w"> </span><span class="no">interp_related</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="no">base_type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">interp_base_type</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">interp_base_type</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">interp_base_type</span><span class="o">)</span><span class="w"> </span><span class="o">(@</span><span class="nn">type</span><span class="p">.</span><span class="no">eqv</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">with_interp</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                      <li>A term in the <code class="language-plaintext highlighter-rouge">UnderLets</code> monad is <code class="language-plaintext highlighter-rouge">UnderLets.interp_related</code> to an interpreted value <code class="language-plaintext highlighter-rouge">v</code> if and only if converting the <code class="language-plaintext highlighter-rouge">UnderLets</code> expression to an <code class="language-plaintext highlighter-rouge">expr</code> (by replacing all of the <code class="language-plaintext highlighter-rouge">UnderLets</code>-let-binders with <code class="language-plaintext highlighter-rouge">expr</code>-let-binders) results in an expression that is <code class="language-plaintext highlighter-rouge">expr.interp_related</code> to <code class="language-plaintext highlighter-rouge">v</code>.</li>
                      <li>A <code class="language-plaintext highlighter-rouge">value</code> is <code class="language-plaintext highlighter-rouge">value_interp_related</code> to an interpreted value <code class="language-plaintext highlighter-rouge">v</code> whenever it sends <code class="language-plaintext highlighter-rouge">interp_related</code> things to <code class="language-plaintext highlighter-rouge">interp_related</code> things (the arrow case), and satisfies the appropriate notion of <code class="language-plaintext highlighter-rouge">interp_related</code> in the base case:
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">with_lets</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">value'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">with_lets</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">with_lets</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">expr_interp_related</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="o">(</span><span class="no">f1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">value'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">value'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">d</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">f2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">d</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">x2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">@</span><span class="no">value_interp_related</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">x2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">value_interp_related</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="no">f1</span><span class="w"> </span><span class="no">x1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">f2</span><span class="w"> </span><span class="no">x2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                      <li>A <code class="language-plaintext highlighter-rouge">rawexpr</code> is <code class="language-plaintext highlighter-rouge">rawexpr_interp_related</code> to an interpreted value <code class="language-plaintext highlighter-rouge">v</code> if both the revealed and unrevealed structures are appropriately <code class="language-plaintext highlighter-rouge">interp_related</code> to <code class="language-plaintext highlighter-rouge">v</code>.  This one, too, is a bit hard to explain in any detail without simply displaying the code:
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">rawexpr_interp_related</span><span class="w"> </span><span class="o">(</span><span class="no">r1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">r1</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">r1</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">r1</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">e1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w"> </span><span class="no">e1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">expr_interp_related</span><span class="w"> </span><span class="no">e1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">v1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="no">v1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">idc1</span><span class="w"> </span><span class="no">t'1</span><span class="w"> </span><span class="no">alt1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="no">alt1</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">/\</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc1</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t'1</span><span class="w"> </span><span class="no">alt1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f1</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="no">alt1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">alt1</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">af</span><span class="w"> </span><span class="no">ax</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kp">exists</span><span class="w"> </span><span class="no">fv</span><span class="w"> </span><span class="no">xv</span><span class="w"> </span><span class="o">(</span><span class="no">pff</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">f1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">pfx</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">x1</span><span class="o">),</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">@</span><span class="no">expr_interp_related</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">af</span><span class="w"> </span><span class="no">fv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">/\</span><span class="w"> </span><span class="o">@</span><span class="no">expr_interp_related</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">ax</span><span class="w"> </span><span class="no">xv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">/\</span><span class="w"> </span><span class="o">@</span><span class="no">rawexpr_interp_related</span><span class="w"> </span><span class="no">f1</span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="no">pff</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">fv</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">/\</span><span class="w"> </span><span class="o">@</span><span class="no">rawexpr_interp_related</span><span class="w"> </span><span class="no">x1</span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="no">pfx</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">xv</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">/\</span><span class="w"> </span><span class="no">fv</span><span class="w"> </span><span class="no">xv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                      <li>We can say when a <code class="language-plaintext highlighter-rouge">unification_resultT'</code> returning an <code class="language-plaintext highlighter-rouge">expr</code> whose <code class="language-plaintext highlighter-rouge">var</code> type is <code class="language-plaintext highlighter-rouge">@value (type.interp base.interp)</code> is interp-related to a <code class="language-plaintext highlighter-rouge">unification_resultT'</code> returning an <code class="language-plaintext highlighter-rouge">expr</code> whose <code class="language-plaintext highlighter-rouge">var</code> type is <code class="language-plaintext highlighter-rouge">type.interp base.interp</code> in the semi-obvious way:
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">interp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">only</span><span class="w"> </span><span class="no">parsing</span><span class="o">).</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">unification_resultT'_interp_related</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">related_unification_resultT'</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">).</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                      <li>We say that a <code class="language-plaintext highlighter-rouge">rawexpr</code>’s types are ok if the revealed and unrevealed structure match on the type level:
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="o">(</span><span class="no">r</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">rawexpr</span><span class="w"> </span><span class="no">var</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">r</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rExpr</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rValue</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rIdent</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">t2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">alt</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">alt</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">s</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                      <li>We can define a transformation that takes in a <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> of pattern type variables to types, together with a <code class="language-plaintext highlighter-rouge">PositiveSet.t</code> of type variables that we care about, and re-creates a new <code class="language-plaintext highlighter-rouge">PositiveMap.t</code> in accordance with the <code class="language-plaintext highlighter-rouge">PositiveSet.t</code>.  This is required to get some theorem types to line up, and is possibly an indication of a leaky abstraction barrier.
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">mk_new_evm0</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">ls</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">find</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">add</span><span class="w"> </span><span class="no">i</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">evm'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm'</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="no">rev</span><span class="w"> </span><span class="no">ls</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="no">only</span><span class="w"> </span><span class="no">parsing</span><span class="o">).</span><span class="w">

</span><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">mk_new_evm'</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">ps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">mk_new_evm0</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">elements</span><span class="w"> </span><span class="no">ps</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="no">only</span><span class="w"> </span><span class="no">parsing</span><span class="o">).</span><span class="w">

</span><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">mk_new_evm</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">ps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">mk_new_evm'</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">ps</span><span class="w"> </span><span class="o">(</span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">empty</span><span class="w"> </span><span class="p">_</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="no">only</span><span class="w"> </span><span class="no">parsing</span><span class="o">).</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                      <li>Given a proof of <code class="language-plaintext highlighter-rouge">@types_match_with evm t re p</code> that the types of <code class="language-plaintext highlighter-rouge">re : rawexpr</code> and <code class="language-plaintext highlighter-rouge">p : pattern t</code> line up under the mapping <code class="language-plaintext highlighter-rouge">evm</code>, and a proof of <code class="language-plaintext highlighter-rouge">rawexpr_types_ok re (type_of_rawexpr re)</code>, we can prove that <code class="language-plaintext highlighter-rouge">type_of_rawexpr re = pattern.type.subst_default t mk_new_evm evm (pattern_collect_vars p)</code>.  We call this theorem <code class="language-plaintext highlighter-rouge">eq_type_of_rawexpr_of_types_match_with'</code>.</li>
                      <li>The final and perhaps most important auxiliary component is the notation of the default interpretation of a pattern.  This is a <code class="language-plaintext highlighter-rouge">with_unification_resultT'</code> which returns the obvious interpreted value after getting all of its data; application nodes become applications, identifiers get interpreted, wildcards are passed through.
                        <ul>
                          <li>This definition itself needs a few auxiliary definitions and context variables.</li>
                          <li>We have a context variable <code class="language-plaintext highlighter-rouge">(pident_to_typed : forall t (idc : pident t) (evm : EvarMap), type_of_list (pident_arg_types t idc) -&gt; ident (pattern.type.subst_default t evm))</code> which takes in a pattern identifier, a mapping of type variables to types, and the arguments bound for that identifier, and returns a PHOAST identifier of the correct type.  We require that all type-instantiations of type variables of pattern identifiers be valid; this means that it doesn’t matter if some type variables are missing from the mapping and we fill them in with <code class="language-plaintext highlighter-rouge">unit</code> instead.</li>
                          <li>We define <code class="language-plaintext highlighter-rouge">lam_type_of_list</code> to convert between the <code class="language-plaintext highlighter-rouge">cps</code> and non-cps versions of type lists:
                            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">type_of_list</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">b</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">prod</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">b</span><span class="o">)</span><span class="w"> </span><span class="no">unit</span><span class="o">).</span><span class="w">
</span><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">type_of_list_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">fold_right</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">a</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">K</span><span class="o">)).</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">lam_type_of_list</span><span class="w"> </span><span class="o">{</span><span class="no">ls</span><span class="w"> </span><span class="no">K</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_list</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">K</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">type_of_list_cps</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="no">ls</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">list_rect</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_list</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">K</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">type_of_list_cps</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="no">ls</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">tt</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">Ts</span><span class="w"> </span><span class="no">rec</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">rec</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">ts</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">ts</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">ls</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                            </div>
                          </li>
                          <li>We may now define the default interpretation:
                            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">pattern_default_interp'</span><span class="w"> </span><span class="o">{</span><span class="no">K</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">{</span><span class="no">struct</span><span class="w"> </span><span class="no">p</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">(</span><span class="no">var</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">K</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">with_unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">K</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="o">(</span><span class="no">var</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">K</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">with_unification_resultT'</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Wildcard</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">lam_type_of_list</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">args</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">ident_interp</span><span class="w"> </span><span class="p">_</span><span class="o">(</span><span class="no">pident_to_typed</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">args</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="no">App</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">pattern_default_interp'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">ef</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">pattern_default_interp'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">ex</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">ef</span><span class="w"> </span><span class="no">ex</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                            </div>
                          </li>
                          <li>To define the unprimed version, which also accounts for the type variables, we must first define the lambda of <code class="language-plaintext highlighter-rouge">forall_vars</code>:
                            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Fixpoint</span><span class="w"> </span><span class="no">lam_forall_vars_gen</span><span class="w"> </span><span class="o">{</span><span class="no">k</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">evm</span><span class="o">,</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">ls</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="nn">PositiveMap</span><span class="p">.</span><span class="no">key</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">evm0</span><span class="o">,</span><span class="w"> </span><span class="no">forall_vars_body</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="no">evm0</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">evm0</span><span class="o">,</span><span class="w"> </span><span class="no">forall_vars_body</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ls</span><span class="w"> </span><span class="no">evm0</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">nil</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">f</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">cons</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">xs</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">lam_forall_vars_gen</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">xs</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">lam_forall_vars</span><span class="w"> </span><span class="o">{</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">PositiveSet</span><span class="p">.</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">k</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">EvarMap</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">f</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">evm</span><span class="o">,</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">evm</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">forall_vars</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">k</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">lam_forall_vars_gen</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">.</span><span class="w">
</span></code></pre></div>                            </div>
                          </li>
                          <li>Now we can define the default interpretation as a <code class="language-plaintext highlighter-rouge">with_unification_resultT</code>:
                            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">pattern_default_interp</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">with_unification_resultT</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">var</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">lam_forall_vars</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">pattern_default_interp'</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">id</span><span class="o">).</span><span class="w">
</span></code></pre></div>                            </div>
                          </li>
                        </ul>
                      </li>
                      <li>Now, finally, we may state the interp-correctness condition of the pattern unifier:
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_unify_pattern'</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="no">v</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hre</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_interp_related</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">H</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">unify_pattern'</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(@</span><span class="no">Some</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">res</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Ht</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">types_match_with</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">p</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Ht'</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">re</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">evm'</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">mk_new_evm</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">(</span><span class="no">pattern_collect_vars</span><span class="w"> </span><span class="no">p</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hty</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">eq_type_of_rawexpr_of_types_match_with'</span><span class="w"> </span><span class="no">Ht</span><span class="w"> </span><span class="no">Ht'</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kp">exists</span><span class="w"> </span><span class="no">resv</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">unification_resultT'_interp_related</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="no">resv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="no">app_transport_with_unification_resultT'_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">pattern_default_interp'</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="no">id</span><span class="o">)</span><span class="w"> </span><span class="no">resv</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(@</span><span class="no">Some</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="no">Hty</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">v</span><span class="o">).</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>We can now glue the type pattern-unifier with the expression pattern-unifier in a straightforward way.  Note that this pattern unifier also has three correctness conditions.
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">unify_pattern</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">T</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">unification_resultT</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">T</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="no">cont</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">unify_types</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">evm</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">unify_pattern'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="no">T</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">cont</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">v</span><span class="o">)))%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
            <ul>
              <li>The first correctness condition is again the cps-identity rule: if you invoke <code class="language-plaintext highlighter-rouge">unify_pattern</code> with any continuation, that must be the same as invoking it with <code class="language-plaintext highlighter-rouge">Some</code>, binding the value in the option monad, and then invoking the continuation on the bound value.</li>
              <li>The <code class="language-plaintext highlighter-rouge">wf</code> correctness condition requires us to define a notion of <code class="language-plaintext highlighter-rouge">wf</code> for <code class="language-plaintext highlighter-rouge">unification_resultT</code>.
                <ul>
                  <li>We say that two <code class="language-plaintext highlighter-rouge">unification_resultT</code>s are <code class="language-plaintext highlighter-rouge">wf</code>-related if their type-variable-maps are equal, and their identifier-arguments and wildcard binding values are appropriately <code class="language-plaintext highlighter-rouge">wf</code>-related:
                    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">related_sigT_by_eq</span><span class="w"> </span><span class="o">{</span><span class="no">A</span><span class="w"> </span><span class="no">P1</span><span class="w"> </span><span class="no">P2</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">A</span><span class="o">,</span><span class="w"> </span><span class="no">P1</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">P2</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">sigT</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">P1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">y</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">sigT</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="no">P2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">pf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">projT1</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">projT1</span><span class="w"> </span><span class="no">y</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="no">pf</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">projT2</span><span class="w"> </span><span class="no">x</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">projT2</span><span class="w"> </span><span class="no">y</span><span class="o">)</span><span class="w"> </span><span class="o">}.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">related_unification_resultT</span><span class="w"> </span><span class="o">{</span><span class="no">var1</span><span class="w"> </span><span class="no">var2</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="o">,</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="o">)</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">related_sigT_by_eq</span><span class="w"> </span><span class="o">(@</span><span class="no">related_unification_resultT'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">R</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">).</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">wf_unification_resultT</span><span class="w"> </span><span class="o">(</span><span class="no">G</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="no">t1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">(</span><span class="no">var1</span><span class="w"> </span><span class="no">t1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t1</span><span class="o">)%</span><span class="no">type</span><span class="o">})</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var1</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var2</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">related_unification_resultT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                    </div>
                  </li>
                  <li>The <code class="language-plaintext highlighter-rouge">wf</code> correctness condition is then that if we have two <code class="language-plaintext highlighter-rouge">wf_rawexpr</code>-related <code class="language-plaintext highlighter-rouge">rawexpr</code>s, invoking <code class="language-plaintext highlighter-rouge">unify_pattern</code> on each <code class="language-plaintext highlighter-rouge">rawexpr</code> to unify it with a singular pattern <code class="language-plaintext highlighter-rouge">p</code>, with continuation <code class="language-plaintext highlighter-rouge">Some</code>, results either in <code class="language-plaintext highlighter-rouge">None</code> in both cases, or in two <code class="language-plaintext highlighter-rouge">unification_resultT</code>s which are <code class="language-plaintext highlighter-rouge">wf_unification_resultT</code>-related.</li>
                  <li>The interpretation correctness condition is a bit of a mouthful.
                    <ul>
                      <li>We say that two <code class="language-plaintext highlighter-rouge">unification_resultT</code>s are interp-related if their mappings of type variables to types are equal, and their packages of non-type binding data are appropriately interp-related.
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">interp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">only</span><span class="w"> </span><span class="no">parsing</span><span class="o">).</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">unification_resultT_interp_related</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">unification_resultT</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">related_unification_resultT</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">).</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                      <li>We can now state the interpretation correctness condition, which is a bit hard for me to meaningfully talk about in English words except by saying “it does the right thing for a good notion of ‘right’”:
                        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_unify_pattern</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">res</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hre</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_interp_related</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Ht'</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">re</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">H</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">unify_pattern</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(@</span><span class="no">Some</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">res</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">evm'</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">mk_new_evm</span><span class="w"> </span><span class="o">(</span><span class="no">projT1</span><span class="w"> </span><span class="no">res</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">pattern_collect_vars</span><span class="w"> </span><span class="no">p</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kp">exists</span><span class="w"> </span><span class="no">resv</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">unification_resultT_interp_related</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="no">resv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="kp">exists</span><span class="w"> </span><span class="no">Hty</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="no">app_with_unification_resultT_cps</span><span class="w"> </span><span class="o">(@</span><span class="no">pattern_default_interp</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">)</span><span class="w"> </span><span class="no">resv</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(@</span><span class="no">Some</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">))</span><span class="w"> </span><span class="no">evm'</span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="no">Hty</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">v</span><span class="o">))).</span><span class="w">
</span></code></pre></div>                        </div>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Plugging in the arguments to a rewrite rule: Take 2
    <ul>
      <li>There is one more definition before we put all of the rewrite replacement rule pieces together: we describe a way to handle the fact that we are underneath zero, one, or two monads.  The way we handle this is by just assuming that we are underneath two monads, and issuing monad-return statements as necessary to correct:
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">normalize_deep_rewrite_rule</span><span class="w"> </span><span class="o">{</span><span class="no">should_do_again</span><span class="w"> </span><span class="no">with_opt</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="no">with_opt</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">with_opt</span><span class="o">,</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="o">,</span><span class="w"> </span><span class="no">true</span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">false</span><span class="o">,</span><span class="w"> </span><span class="no">true</span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="o">,</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">x</span><span class="p">;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">Base</span><span class="w"> </span><span class="no">x</span><span class="o">))%</span><span class="no">option</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">false</span><span class="o">,</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">Base</span><span class="w"> </span><span class="no">x</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">cps</span><span class="pi">.</span><span class="w">
</span></code></pre></div>        </div>
        <ul>
          <li>The <code class="language-plaintext highlighter-rouge">wf</code> correctness condition, unsurprisingly, just says that if two rewrite replacement rules are appropriately <code class="language-plaintext highlighter-rouge">wf</code>-related, then their normalizations are too.  This is quite verbose to state, though, because it requires traversing multiple layers of monads and pesky dependent types.  TODO: should this code actually be included?
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">wf_maybe_do_again_expr</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">rew_should_do_again1</span><span class="w"> </span><span class="no">rew_should_do_again2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">G</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">(</span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">)%</span><span class="no">type</span><span class="o">})</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="no">var</span><span class="p">:</span><span class="o">=</span><span class="kr">if</span><span class="w"> </span><span class="no">rew_should_do_again1</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="o">@</span><span class="no">value</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">var1</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="no">var</span><span class="p">:</span><span class="o">=</span><span class="kr">if</span><span class="w"> </span><span class="no">rew_should_do_again2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="o">@</span><span class="no">value</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">var2</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">rew_should_do_again1</span><span class="o">,</span><span class="w"> </span><span class="no">rew_should_do_again2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">return</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="no">var</span><span class="p">:</span><span class="o">=</span><span class="kr">if</span><span class="w"> </span><span class="no">rew_should_do_again1</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="o">@</span><span class="no">value</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">var1</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="no">var</span><span class="p">:</span><span class="o">=</span><span class="kr">if</span><span class="w"> </span><span class="no">rew_should_do_again2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="o">@</span><span class="no">value</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">var2</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">true</span><span class="o">,</span><span class="w"> </span><span class="no">true</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kp">exists</span><span class="w"> </span><span class="no">G'</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">v1'</span><span class="w"> </span><span class="no">v2'</span><span class="o">,</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">(</span><span class="no">v1'</span><span class="o">,</span><span class="w"> </span><span class="no">v2'</span><span class="o">))</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">v1'</span><span class="w"> </span><span class="no">v2'</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">false</span><span class="o">,</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">wf_maybe_under_lets_expr</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">T1</span><span class="w"> </span><span class="no">T2</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">P</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">(</span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">)%</span><span class="no">type</span><span class="o">}</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">G</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">(</span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">)%</span><span class="no">type</span><span class="o">})</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">rew_under_lets1</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">rew_under_lets1</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">T1</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">T2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">rew_under_lets1</span><span class="o">,</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">return</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">rew_under_lets1</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">T1</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">T1</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">T2</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">T2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">true</span><span class="o">,</span><span class="w"> </span><span class="no">true</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">false</span><span class="o">,</span><span class="w"> </span><span class="no">false</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">maybe_option_eq</span><span class="w"> </span><span class="o">{</span><span class="no">A</span><span class="w"> </span><span class="no">B</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">opt1</span><span class="w"> </span><span class="no">opt2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">R</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">opt1</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">A</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">A</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">opt2</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="no">B</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">B</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">opt1</span><span class="o">,</span><span class="w"> </span><span class="no">opt2</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">true</span><span class="o">,</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">option_eq</span><span class="w"> </span><span class="no">R</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">false</span><span class="o">,</span><span class="w"> </span><span class="no">false</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">R</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="o">,</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">False</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">wf_deep_rewrite_ruleTP_gen</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">G</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">(</span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">)%</span><span class="no">type</span><span class="o">})</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">rew_should_do_again1</span><span class="w"> </span><span class="no">rew_with_opt1</span><span class="w"> </span><span class="no">rew_under_lets1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">rew_should_do_again2</span><span class="w"> </span><span class="no">rew_with_opt2</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen1</span><span class="w"> </span><span class="no">rew_should_do_again1</span><span class="w"> </span><span class="no">rew_with_opt1</span><span class="w"> </span><span class="no">rew_under_lets1</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen2</span><span class="w"> </span><span class="no">rew_should_do_again2</span><span class="w"> </span><span class="no">rew_with_opt2</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">maybe_option_eq</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">wf_maybe_under_lets_expr</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">wf_maybe_do_again_expr</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">G</span><span class="o">).</span><span class="w">

</span><span class="k">Lemma</span><span class="w"> </span><span class="no">wf_normalize_deep_rewrite_rule</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">G</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">should_do_again1</span><span class="w"> </span><span class="no">with_opt1</span><span class="w"> </span><span class="no">under_lets1</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">should_do_again2</span><span class="w"> </span><span class="no">with_opt2</span><span class="w"> </span><span class="no">under_lets2</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">r1</span><span class="w"> </span><span class="no">r2</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hwf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">wf_deep_rewrite_ruleTP_gen</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">should_do_again1</span><span class="w"> </span><span class="no">with_opt1</span><span class="w"> </span><span class="no">under_lets1</span><span class="w"> </span><span class="no">should_do_again2</span><span class="w"> </span><span class="no">with_opt2</span><span class="w"> </span><span class="no">under_lets2</span><span class="w"> </span><span class="no">r1</span><span class="w"> </span><span class="no">r2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option_eq</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">wf_maybe_do_again_expr</span><span class="w"> </span><span class="no">G'</span><span class="o">)</span><span class="w"> </span><span class="no">G</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">normalize_deep_rewrite_rule</span><span class="w"> </span><span class="no">r1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">normalize_deep_rewrite_rule</span><span class="w"> </span><span class="no">r2</span><span class="o">).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>We do not require any interp-correctness condition on <code class="language-plaintext highlighter-rouge">normalize_deep_rewrite_rule</code>.  Instead, we bake <code class="language-plaintext highlighter-rouge">normalize_deep_rewrite_rule</code> into the per-rewrite-rule correctness conditions that a user must prove of every individual rewrite rule.</li>
        </ul>
      </li>
      <li>Actually, I lied.  We need to define the type of a rewrite rule before we can say what it means for one to be correct.
        <ul>
          <li>An <code class="language-plaintext highlighter-rouge">anypattern</code> is a dynamically-typed pattern.  This is used so that we can talk about <code class="language-plaintext highlighter-rouge">list</code>s of rewrite rules.
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Record</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="no">anypattern</span><span class="w"> </span><span class="o">{</span><span class="no">ident</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Type</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">type_of_anypattern</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">pattern_of_anypattern</span><span class="w"> </span><span class="p">:</span><span class="o">&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">pattern</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">type_of_anypattern</span><span class="w"> </span><span class="o">}.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>A <code class="language-plaintext highlighter-rouge">rewrite_ruleT</code> is just a sigma of a pattern of any type, with <code class="language-plaintext highlighter-rouge">rewrite_rule_data</code> over that pattern:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">rewrite_ruleTP</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">anypattern</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_rule_data</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="no">pattern_of_anypattern</span><span class="w"> </span><span class="no">p</span><span class="o">)).</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">rewrite_ruleT</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">sigT</span><span class="w"> </span><span class="no">rewrite_ruleTP</span><span class="pi">.</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">rewrite_rulesT</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="no">list</span><span class="w"> </span><span class="no">rewrite_ruleT</span><span class="o">).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>We now define a helper definition to support rewriting again in the output of a rewrite rule.  This is a separate definition mostly to make dependent types slightly less painful.
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">maybe_do_againT</span><span class="w"> </span><span class="o">(</span><span class="no">should_do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">((@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">var</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">)).</span><span class="w">
</span><span class="k">Definition</span><span class="w"> </span><span class="no">maybe_do_again</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">should_do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">if</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="no">maybe_do_againT</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">then</span><span class="w"> </span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">else</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">Base</span><span class="pi">.</span><span class="w">
</span></code></pre></div>        </div>
        <ul>
          <li>You might think that the correctness condition for this is trivial.  And, indeed, the <code class="language-plaintext highlighter-rouge">wf</code> correctness condition is straightforward.  In fact, we have already seen it above in <code class="language-plaintext highlighter-rouge">wf_maybe_do_again_expr</code>, as there is no proof, only a definition of what it means for things to be related depending on whether or not we are rewriting again.</li>
          <li>The interpretation correctness rule, on the other hand, is surprisingly subtle.  You may have noticed above that <code class="language-plaintext highlighter-rouge">expr.interp_related</code> is parameterized on an arbitrary <code class="language-plaintext highlighter-rouge">var</code> type, and an arbitrary relation between the <code class="language-plaintext highlighter-rouge">var</code> type and <code class="language-plaintext highlighter-rouge">type.interp base.interp</code>.  I said that it is equivalent to equality of interpretation under the assumption of function extensionality, but that is only the case if <code class="language-plaintext highlighter-rouge">var</code> is instantiated to <code class="language-plaintext highlighter-rouge">type.interp</code> and the relation is equality or pointwise/extensional equivalence.  Here, we must instantiate the <code class="language-plaintext highlighter-rouge">var</code> type with <code class="language-plaintext highlighter-rouge">@value var</code>, and the relation with <code class="language-plaintext highlighter-rouge">value_interp_related</code>.  We then prove that for any “good” notion of rewriting again, if our input value is interp-related to an interpreted value, the result of maybe rewriting again is also interp-related to that interpreted value.
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_maybe_do_again</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hdo_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">should_do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">He</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">then</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">else</span><span class="w"> </span><span class="no">expr_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w"> </span><span class="o">(@</span><span class="no">maybe_do_again</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">do_again</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>For the purposes of ensuring that reduction does not get blocked where it should not, we only allow rewrite rules to match on fully applied patterns, and to return base-typed expressions.  We patch this broken abstraction barrier with
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">base_type_of</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">__</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">unit</span><span class="w"> </span><span class="kr">end</span><span class="o">).</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>Finally, we can define what it means to rewrite with a particular rewrite rule.  It is messy primarily due to continuation passing style, optional values, and type casts.  Note that we use <code class="language-plaintext highlighter-rouge">&lt;-</code> to mean “bind in whatever monad is the top-most scope”.  Other than these complications, it just unifies the pattern with the <code class="language-plaintext highlighter-rouge">rawexpr</code> to get binding data, applies the rewrite replacement rule to the binding data, normalizes the applied rewrite replacement rule, calls the rewriter again on the output if it should, and returns the result.
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">rewrite_with_rule</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">e'</span><span class="w"> </span><span class="o">(</span><span class="no">pf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_ruleT</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="k">'</span><span class="no">existT</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">pf</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">let</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">rew_should_do_again</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">unify_pattern</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">e'</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="no">pattern_of_anypattern</span><span class="w"> </span><span class="no">p</span><span class="o">)</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">x</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">app_with_unification_resultT_cps</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">rew_replacement</span><span class="w"> </span><span class="no">f</span><span class="o">)</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">f'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">tr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">try_make_transport_cps</span><span class="w"> </span><span class="o">(@</span><span class="nn">base</span><span class="p">.</span><span class="no">try_make_transport_cps</span><span class="o">)</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">tr</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">tr</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">tr'</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">try_make_transport_cps</span><span class="w"> </span><span class="o">(@</span><span class="nn">base</span><span class="p">.</span><span class="no">try_make_transport_cps</span><span class="o">)</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">tr'</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">tr'</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">option_bind'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">normalize_deep_rewrite_rule</span><span class="w"> </span><span class="o">(</span><span class="no">projT2</span><span class="w"> </span><span class="no">f'</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">fv</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="o">(</span><span class="no">fv</span><span class="w"> </span><span class="o">&lt;--</span><span class="w"> </span><span class="no">fv</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">fv</span><span class="w"> </span><span class="o">&lt;--</span><span class="w"> </span><span class="no">maybe_do_again</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="o">(</span><span class="no">base_type_of</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e'</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="no">tr</span><span class="w"> </span><span class="no">fv</span><span class="o">)</span><span class="p">;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">Base</span><span class="w"> </span><span class="o">(</span><span class="no">tr'</span><span class="w"> </span><span class="no">fv</span><span class="o">))%</span><span class="no">under_lets</span><span class="o">))%</span><span class="no">option</span><span class="o">)%</span><span class="no">cps</span><span class="o">)%</span><span class="no">option</span><span class="o">)%</span><span class="no">cps</span><span class="o">)%</span><span class="no">cps</span><span class="o">).</span><span class="w">
</span></code></pre></div>        </div>
        <ul>
          <li>We once again do not have any <code class="language-plaintext highlighter-rouge">wf</code> correctness condition for <code class="language-plaintext highlighter-rouge">rewrite_with_rule</code>; we merely unfold it as needed.</li>
          <li>To write down the correctness condition for <code class="language-plaintext highlighter-rouge">rewrite_with_rule</code>, we must first define what it means for <code class="language-plaintext highlighter-rouge">rewrite_rule_data</code> to be “good”.
            <ul>
              <li>Here is where we use <code class="language-plaintext highlighter-rouge">normalize_deep_rewrite_rule</code>.  Replacement rule data is good with respect to an interpretation value if normalizing it gives an appropriately interp-related thing to that interpretation value:
                <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">interp</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">interp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">only</span><span class="w"> </span><span class="no">parsing</span><span class="o">).</span><span class="w">

</span><span class="k">Definition</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen_good_relation</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">should_do_again</span><span class="w"> </span><span class="no">with_opt</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">bool</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">v1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">deep_rewrite_ruleTP_gen</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="no">with_opt</span><span class="w"> </span><span class="no">under_lets</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">v2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">normalize_deep_rewrite_rule</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">match</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">True</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">interp_related</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">ident_interp</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">should_do_again</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="o">(@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="o">(</span><span class="kr">if</span><span class="w"> </span><span class="no">should_do_again</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="o">@</span><span class="no">value</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="no">var</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">then</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">else</span><span class="w"> </span><span class="no">expr_interp_related</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">v1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                </div>
              </li>
              <li>Rewrite rule data is good if, for any interp-related binding data, the replacement function applied to the value-binding-data is interp-related to the default interpretation of the pattern applied to the interpreted-value-binding-data:
                <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">rewrite_rule_data_interp_goodT</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">r</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_rule_data</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">related_unification_resultT</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option_eq</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">fx</span><span class="w"> </span><span class="no">gy</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">related_sigT_by_eq</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">evm</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">deep_rewrite_ruleTP_gen_good_relation</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">rew_should_do_again</span><span class="w"> </span><span class="no">r</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rew_with_opt</span><span class="w"> </span><span class="no">r</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rew_under_lets</span><span class="w"> </span><span class="no">r</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="nn">type</span><span class="p">.</span><span class="no">subst_default</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">evm</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">fx</span><span class="w"> </span><span class="no">gy</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">app_with_unification_resultT_cps</span><span class="w"> </span><span class="o">(</span><span class="no">rew_replacement</span><span class="w"> </span><span class="no">r</span><span class="o">)</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(@</span><span class="no">Some</span><span class="w"> </span><span class="p">_</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">app_with_unification_resultT_cps</span><span class="w"> </span><span class="o">(</span><span class="no">pattern_default_interp</span><span class="w"> </span><span class="no">p</span><span class="o">)</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(@</span><span class="no">Some</span><span class="w"> </span><span class="p">_</span><span class="o">)).</span><span class="w">
</span></code></pre></div>                </div>
              </li>
              <li>The interpretation correctness condition then says that if the rewrite rule is good, the <code class="language-plaintext highlighter-rouge">rawexpr</code> <code class="language-plaintext highlighter-rouge">re</code> has ok types, the “rewrite again” function is good, and <code class="language-plaintext highlighter-rouge">rewrite_with_rule</code> succeeds and outputs an expression <code class="language-plaintext highlighter-rouge">v1</code>, then <code class="language-plaintext highlighter-rouge">v1</code> is interp-related to any interpreted value which <code class="language-plaintext highlighter-rouge">re</code> is interp-related to:
                <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_rewrite_with_rule</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hdo_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rewr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_ruleT</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hrewr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rule_data_interp_goodT</span><span class="w"> </span><span class="o">(</span><span class="no">projT2</span><span class="w"> </span><span class="no">rewr</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Ht</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">re</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Ht'</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">re</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_with_rule</span><span class="w"> </span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">rewr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">Some</span><span class="w"> </span><span class="no">v1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">rawexpr_interp_related</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="no">Ht</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="pi">.</span><span class="w">
</span></code></pre></div>                </div>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h3 id="tying-it-all-together">Tying it all together</h3>
<ul>
  <li>We can now say what it means to rewrite with a decision tree in a given <code class="language-plaintext highlighter-rouge">rawexpr</code> <code class="language-plaintext highlighter-rouge">re</code>.  We evaluate the decision tree, and whenever we are asked to try the <code class="language-plaintext highlighter-rouge">k</code>th rewrite rule, we look for it in our list of rewrite rules, and invoke <code class="language-plaintext highlighter-rouge">rewrite_with_rule</code>.  By default, if rewriting fails, we will eventually return <code class="language-plaintext highlighter-rouge">expr_of_rawexpr re</code>.
    <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">eval_rewrite_rules</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">d</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">rews</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">defaulte</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">expr_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">eval_decision_tree</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="p">::</span><span class="no">nil</span><span class="o">)</span><span class="w"> </span><span class="no">d</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="no">ctx</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">ctx</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="no">option</span><span class="w"> </span><span class="o">(</span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">)))</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="no">e'</span><span class="p">::</span><span class="no">nil</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">(</span><span class="no">pf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="no">nth_error</span><span class="w"> </span><span class="no">rews</span><span class="w"> </span><span class="no">k</span><span class="p">;</span><span class="w"> </span><span class="no">rewrite_with_rule</span><span class="w"> </span><span class="no">e'</span><span class="w"> </span><span class="no">pf</span><span class="o">)%</span><span class="no">option</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">None</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="kr">end</span><span class="o">)</span><span class="p">;;;</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">Base</span><span class="w"> </span><span class="no">defaulte</span><span class="o">))%</span><span class="no">option</span><span class="pi">.</span><span class="w">
</span></code></pre></div>    </div>
    <ul>
      <li>To define the correctness conditions, we must first define what it means for lists of rewrite rules to be good.
        <ul>
          <li>For <code class="language-plaintext highlighter-rouge">wf</code>, we need to catch up a bit before getting to lists of rewrite rules.  These say the obvious things:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="k">Definition</span><span class="w"> </span><span class="no">wf_with_unif_rewrite_ruleTP_gen</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">G</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">(</span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">)%</span><span class="no">type</span><span class="o">})</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">rew_should_do_again1</span><span class="w"> </span><span class="no">rew_with_opt1</span><span class="w"> </span><span class="no">rew_under_lets1</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">rew_should_do_again2</span><span class="w"> </span><span class="no">rew_with_opt2</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">with_unif_rewrite_ruleTP_gen1</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">rew_should_do_again1</span><span class="w"> </span><span class="no">rew_with_opt1</span><span class="w"> </span><span class="no">rew_under_lets1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">with_unif_rewrite_ruleTP_gen2</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">rew_should_do_again2</span><span class="w"> </span><span class="no">rew_with_opt2</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">g</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">wf_unification_resultT</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">y</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">option_eq</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="o">(</span><span class="no">fx</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen1</span><span class="w"> </span><span class="no">rew_should_do_again1</span><span class="w"> </span><span class="no">rew_with_opt1</span><span class="w"> </span><span class="no">rew_under_lets1</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">})</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">gy</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">evm</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="no">deep_rewrite_ruleTP_gen2</span><span class="w"> </span><span class="no">rew_should_do_again2</span><span class="w"> </span><span class="no">rew_with_opt2</span><span class="w"> </span><span class="no">rew_under_lets2</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">})</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">related_sigT_by_eq</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">wf_deep_rewrite_ruleTP_gen</span><span class="w"> </span><span class="no">G</span><span class="o">)</span><span class="w"> </span><span class="no">fx</span><span class="w"> </span><span class="no">gy</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">app_with_unification_resultT_cps</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(@</span><span class="no">Some</span><span class="w"> </span><span class="p">_</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">app_with_unification_resultT_cps</span><span class="w"> </span><span class="no">g</span><span class="w"> </span><span class="no">y</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(@</span><span class="no">Some</span><span class="w"> </span><span class="p">_</span><span class="o">)).</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="k">Definition</span><span class="w"> </span><span class="no">wf_rewrite_rule_data</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">G</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">list</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">(</span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">)%</span><span class="no">type</span><span class="o">})</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">{</span><span class="no">p</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">pattern</span><span class="w"> </span><span class="no">t</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">r1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_rule_data1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">r2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_rule_data2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">p</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">wf_with_unif_rewrite_ruleTP_gen</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">rew_replacement</span><span class="w"> </span><span class="no">r1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rew_replacement</span><span class="w"> </span><span class="no">r2</span><span class="o">).</span><span class="w">

</span></code></pre></div>            </div>
          </li>
          <li>Two lists of rewrite rules are <code class="language-plaintext highlighter-rouge">wf</code> related if they have the same length, and if any pair of rules in their zipper (<code class="language-plaintext highlighter-rouge">List.combine</code>) have equal patterns and <code class="language-plaintext highlighter-rouge">wf</code>-related data:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">rewrite_rules_goodT</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">rew1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rew2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">rew1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">length</span><span class="w"> </span><span class="no">rew2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">/\</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">p1</span><span class="w"> </span><span class="no">r1</span><span class="w"> </span><span class="no">p2</span><span class="w"> </span><span class="no">r2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">p1</span><span class="w"> </span><span class="no">r1</span><span class="o">,</span><span class="w"> </span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">p2</span><span class="w"> </span><span class="no">r2</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">combine</span><span class="w"> </span><span class="no">rew1</span><span class="w"> </span><span class="no">rew2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">{</span><span class="w"> </span><span class="no">pf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">p2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">G</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">wf_rewrite_rule_data</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="o">[</span><span class="kr">fun</span><span class="w"> </span><span class="no">tp</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">rewrite_rule_data1</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="nn">pattern</span><span class="p">.</span><span class="no">pattern_of_anypattern</span><span class="w"> </span><span class="no">tp</span><span class="o">)]</span><span class="w"> </span><span class="no">pf</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">r1</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="no">r2</span><span class="w"> </span><span class="o">}).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>A list of rewrite rules is good for interpretation if every rewrite rule in that list is good for interpretation:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">rewrite_rules_interp_goodT</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">rews</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">Prop</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">r</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">p</span><span class="w"> </span><span class="no">r</span><span class="o">)</span><span class="w"> </span><span class="no">rews</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">rewrite_rule_data_interp_goodT</span><span class="w"> </span><span class="no">r</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>The <code class="language-plaintext highlighter-rouge">wf</code>-correctness condition for <code class="language-plaintext highlighter-rouge">eval_rewrite_rules</code> says the obvious thing: for <code class="language-plaintext highlighter-rouge">wf</code>-related “rewrite again” functions, <code class="language-plaintext highlighter-rouge">wf</code>-related lists of rewrite rules, and <code class="language-plaintext highlighter-rouge">wf</code>-related <code class="language-plaintext highlighter-rouge">rawexpr</code>s, the output of <code class="language-plaintext highlighter-rouge">eval_rewrite_rules</code> is <code class="language-plaintext highlighter-rouge">wf</code>-related:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">wf_eval_rewrite_rules</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var1</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="o">(@</span><span class="no">expr</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var2</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="o">(@</span><span class="no">expr</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">wf_do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kp">exists</span><span class="w"> </span><span class="no">G'</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">,</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">v1</span><span class="o">,</span><span class="w"> </span><span class="no">v2</span><span class="o">))</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Compile</span><span class="p">.</span><span class="no">wf_value</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w"> </span><span class="o">/\</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G'</span><span class="o">)</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(@</span><span class="no">do_again1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e1</span><span class="o">)</span><span class="w"> </span><span class="o">(@</span><span class="no">do_again2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e2</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">d</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">decision_tree</span><span class="w"> </span><span class="no">raw_pident</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rew1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rew2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hrew</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rules_goodT</span><span class="w"> </span><span class="no">rew1</span><span class="w"> </span><span class="no">rew2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">re1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">rawexpr</span><span class="w"> </span><span class="no">var1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">re2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">rawexpr</span><span class="w"> </span><span class="no">var2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hwf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re1</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">re2</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">wf</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G'</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="o">[</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">)]</span><span class="w"> </span><span class="o">(</span><span class="no">proj1</span><span class="w"> </span><span class="o">(</span><span class="no">eq_type_of_rawexpr_of_wf</span><span class="w"> </span><span class="no">Hwf</span><span class="o">))</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="o">(</span><span class="no">eval_rewrite_rules1</span><span class="w"> </span><span class="no">do_again1</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">rew1</span><span class="w"> </span><span class="no">re1</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="o">[</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">)]</span><span class="w"> </span><span class="o">(</span><span class="no">proj2</span><span class="w"> </span><span class="o">(</span><span class="no">eq_type_of_rawexpr_of_wf</span><span class="w"> </span><span class="no">Hwf</span><span class="o">))</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="o">(</span><span class="no">eval_rewrite_rules2</span><span class="w"> </span><span class="no">do_again2</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">rew2</span><span class="w"> </span><span class="no">re2</span><span class="o">)).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>The interpretation correctness is also the expected one: for a “rewrite again” function that preserves interp-relatedness, a good-for-interp list of rewrite rules, a <code class="language-plaintext highlighter-rouge">rawexpr</code> whose types are ok and which is interp-related to a value <code class="language-plaintext highlighter-rouge">v</code>, the result of <code class="language-plaintext highlighter-rouge">eval_rewrite_rules</code> is interp-related to <code class="language-plaintext highlighter-rouge">v</code>:
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_eval_rewrite_rules</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">d</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rew_rules</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">re</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hre</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">re</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">res</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">eval_rewrite_rules</span><span class="w"> </span><span class="no">do_again</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">rew_rules</span><span class="w"> </span><span class="no">re</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hdo_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_interp_related</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hrew_rules</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rules_interp_goodT</span><span class="w"> </span><span class="no">rew_rules</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="no">v</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Only one piece remains (other than defining particular rewrite rules and proving them good).  If you were following carefully, you might note that <code class="language-plaintext highlighter-rouge">eval_rewrite_rules</code> takes in a <code class="language-plaintext highlighter-rouge">rawexpr</code> and produces an <code class="language-plaintext highlighter-rouge">UnderLets expr</code>, while <code class="language-plaintext highlighter-rouge">rewrite_bottomup</code> expects a function <code class="language-plaintext highlighter-rouge">rewrite_head : forall t (idc : ident t), value_with_lets t</code>.  From a PHOAST identifier, we must construct a <code class="language-plaintext highlighter-rouge">value_with_lets</code> which collects all of the <code class="language-plaintext highlighter-rouge">value</code> arguments to the identifier and performs <code class="language-plaintext highlighter-rouge">eval_rewrite_rules</code> once the identifier is fully applied.  We call this function <code class="language-plaintext highlighter-rouge">assemble_identifier_rewriters</code>, and it is built out of a small number of pieces.
    <ul>
      <li>We define a convenience function that takes a <code class="language-plaintext highlighter-rouge">value</code> and an <code class="language-plaintext highlighter-rouge">expr</code> at the same type, and produces a <code class="language-plaintext highlighter-rouge">rawexpr</code> by using <code class="language-plaintext highlighter-rouge">rExpr</code> on the expr if the type is a base type, and <code class="language-plaintext highlighter-rouge">rValue</code> on the <code class="language-plaintext highlighter-rouge">value</code> otherwise.  Morally, the <code class="language-plaintext highlighter-rouge">expr</code> and the <code class="language-plaintext highlighter-rouge">value</code> should be the same term, modulo <code class="language-plaintext highlighter-rouge">reify</code> and/or <code class="language-plaintext highlighter-rouge">reflect</code>:
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Definition</span><span class="w"> </span><span class="no">rValueOrExpr2</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">rawexpr</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">rExpr</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">e</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">rValue</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="pi">.</span><span class="w">
</span></code></pre></div>        </div>
      </li>
      <li>We take in a context variable (eventually autogenerated by python) which eta-iota-expands a function over an identifier by producing a <code class="language-plaintext highlighter-rouge">match</code> on the identifier.  Its specification is that it is pointwise-equal to function application; it exists entirely so that we can perform rewrite-rule-compilation time reduction on the rewrite rules by writing down the cases for every head identifier separately.  The context variable is <code class="language-plaintext highlighter-rouge">eta_ident_cps : forall {T : type.type base.type -&gt; Type} {t} (idc : ident t) (f : forall t', ident t' -&gt; T t'), T t</code>, and we require that <code class="language-plaintext highlighter-rouge">forall T t idc f, @eta_ident_cps T t idc f = f t idc</code>.</li>
      <li>We can now carefully define the function that turns <code class="language-plaintext highlighter-rouge">eval_rewrite_rules</code> into a thing that can be plugged into <code class="language-plaintext highlighter-rouge">rewrite_head</code>.  We take care to preserve thunked computation in <code class="language-plaintext highlighter-rouge">rValue</code> nodes, while describing the alternative structure via <code class="language-plaintext highlighter-rouge">reify</code>.  In general, the stored values are only interp-related to the same things that the “unrevealed structure” expressions are interp-related to.  There is no other relation (that we’ve found) between the values and the expressions, and this caused a great deal of pain when trying to specify the interpretation correctness properties.
        <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Section</span><span class="w"> </span><span class="no">with_do_again</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Context</span><span class="w"> </span><span class="o">(</span><span class="no">dtree</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_rules</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">default_fuel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">nat</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">)).</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="no">Let</span><span class="w"> </span><span class="no">dorewrite1</span><span class="w"> </span><span class="o">(</span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">eval_rewrite_rules</span><span class="w"> </span><span class="no">do_again</span><span class="w"> </span><span class="no">dtree</span><span class="w"> </span><span class="no">rewrite_rules</span><span class="w"> </span><span class="no">e</span><span class="pi">.</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Fixpoint</span><span class="w"> </span><span class="no">assemble_identifier_rewriters'</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">P</span><span class="o">,</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="kr">match</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kr">return</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr</span><span class="o">,</span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">P</span><span class="o">,</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="kp">with</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="p">_</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="no">dorewrite1</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">|</span><span class="w"> </span><span class="nn">type</span><span class="p">.</span><span class="no">arrow</span><span class="w"> </span><span class="no">s</span><span class="w"> </span><span class="no">d</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">fun</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="no">k</span><span class="w"> </span><span class="o">(</span><span class="no">x</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value'</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kr">let</span><span class="w"> </span><span class="no">x'</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">reify</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="kr">in</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">@</span><span class="no">assemble_identifier_rewriters'</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="o">(</span><span class="no">rApp</span><span class="w"> </span><span class="no">f</span><span class="w"> </span><span class="o">(</span><span class="no">rValueOrExpr2</span><span class="w"> </span><span class="no">x</span><span class="w"> </span><span class="no">x'</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">k</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">(</span><span class="no">expr_of_rawexpr</span><span class="w"> </span><span class="no">f</span><span class="o">)</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="no">x'</span><span class="o">))%</span><span class="no">expr</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">id</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="kr">end</span><span class="o">%</span><span class="no">under_lets</span><span class="pi">.</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Definition</span><span class="w"> </span><span class="no">assemble_identifier_rewriters</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">t</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">eta_ident_cps</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="no">idc'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">assemble_identifier_rewriters'</span><span class="w"> </span><span class="no">t'</span><span class="w"> </span><span class="o">(</span><span class="no">rIdent</span><span class="w"> </span><span class="no">true</span><span class="w"> </span><span class="no">idc'</span><span class="w"> </span><span class="o">#</span><span class="no">idc'</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">id</span><span class="o">)).</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">with_do_again</span><span class="pi">.</span><span class="w">
</span></code></pre></div>        </div>
        <ul>
          <li>The <code class="language-plaintext highlighter-rouge">wf</code>-correctness condition for <code class="language-plaintext highlighter-rouge">assemble_identifier_rewriters'</code> says that if two <code class="language-plaintext highlighter-rouge">rawexpr</code>s are <code class="language-plaintext highlighter-rouge">wf</code>-related, and both continuations are extensionally/pointwise equal to the identity function transported across the appropriate equality proof, then the results of <code class="language-plaintext highlighter-rouge">assemble_identifier_rewriters'</code> are <code class="language-plaintext highlighter-rouge">wf</code>-related, under the assumption that the “rewrite again” functions are appropriately <code class="language-plaintext highlighter-rouge">wf</code>-related and the list of rewrite rules is good.
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Section</span><span class="w"> </span><span class="no">with_do_again</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Context</span><span class="w"> </span><span class="o">(</span><span class="no">dtree</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">decision_tree</span><span class="w"> </span><span class="no">raw_pident</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rew1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT1</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rew2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hrew</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rules_goodT</span><span class="w"> </span><span class="no">rew1</span><span class="w"> </span><span class="no">rew2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var1</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="o">(@</span><span class="no">expr</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var2</span><span class="o">)</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="o">(@</span><span class="no">expr</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">wf_do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">,</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">v1</span><span class="o">,</span><span class="w"> </span><span class="no">v2</span><span class="o">))</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">Compile</span><span class="p">.</span><span class="no">wf_value</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G'</span><span class="o">)</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(@</span><span class="no">do_again1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e1</span><span class="o">)</span><span class="w"> </span><span class="o">(@</span><span class="no">do_again2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e2</span><span class="o">)).</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Lemma</span><span class="w"> </span><span class="no">wf_assemble_identifier_rewriters'</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re1</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">re2</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">K1</span><span class="w"> </span><span class="no">K2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">He</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="o">@</span><span class="no">wf_rawexpr</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re1</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">re2</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">HK1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w"> </span><span class="no">K1</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">rew</span><span class="w"> </span><span class="o">[</span><span class="no">P</span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="no">proj1</span><span class="w"> </span><span class="o">(</span><span class="no">eq_type_of_rawexpr_of_wf</span><span class="w"> </span><span class="no">He</span><span class="o">))</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">HK2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w"> </span><span class="no">K2</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">rew</span><span class="w"> </span><span class="o">[</span><span class="no">P</span><span class="o">]</span><span class="w"> </span><span class="o">(</span><span class="no">proj2</span><span class="w"> </span><span class="o">(</span><span class="no">eq_type_of_rawexpr_of_wf</span><span class="w"> </span><span class="no">He</span><span class="o">))</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">wf_value_with_lets</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(@</span><span class="no">assemble_identifier_rewriters'</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">rew1</span><span class="w"> </span><span class="no">do_again1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re1</span><span class="w"> </span><span class="no">K1</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(@</span><span class="no">assemble_identifier_rewriters'</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">rew2</span><span class="w"> </span><span class="no">do_again2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re2</span><span class="w"> </span><span class="no">K2</span><span class="o">).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>The <code class="language-plaintext highlighter-rouge">wf</code>-correctness condition for <code class="language-plaintext highlighter-rouge">assemble_identifier_rewriters</code> merely says that the outputs are always <code class="language-plaintext highlighter-rouge">wf</code>-related, again under the assumption that the “rewrite again” functions are appropriately <code class="language-plaintext highlighter-rouge">wf</code>-related and the list of rewrite rules is good.
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">wf_assemble_identifier_rewriters</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">wf_value_with_lets</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">G</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(@</span><span class="no">assemble_identifier_rewriters</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">rew1</span><span class="w"> </span><span class="no">do_again1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(@</span><span class="no">assemble_identifier_rewriters</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">rew2</span><span class="w"> </span><span class="no">do_again2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="o">).</span><span class="w">
</span><span class="k">Proof</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>The interpretation correctness condition says that for a good “rewrite again” function, a good-for-interpretation list of rewrite rules, a <code class="language-plaintext highlighter-rouge">rawexpr</code> <code class="language-plaintext highlighter-rouge">re</code> whose types are ok and which is interp-related to an interpreted value <code class="language-plaintext highlighter-rouge">v</code>, the result of <code class="language-plaintext highlighter-rouge">assemble_identifier_rewriters'</code> is interp-related to <code class="language-plaintext highlighter-rouge">v</code>.  The actual statement is slightly more obscure, parameterizing over types which are equal to computed things, primarily for ease of induction in the proof.
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_assemble_identifier_rewriters'</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">dt</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rew_rules</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">K</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">res</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">assemble_identifier_rewriters'</span><span class="w"> </span><span class="no">dt</span><span class="w"> </span><span class="no">rew_rules</span><span class="w"> </span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">K</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hre</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_types_ok</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="o">(</span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">re</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Ht</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">type_of_rawexpr</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">HK</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">K</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">P</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">rew</span><span class="w"> </span><span class="o">[</span><span class="no">P</span><span class="o">]</span><span class="w"> </span><span class="no">Ht</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">v</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hdo_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hrew_rules</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rules_interp_goodT</span><span class="w"> </span><span class="no">rew_rules</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hr</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rawexpr_interp_related</span><span class="w"> </span><span class="no">re</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="o">(</span><span class="no">rew</span><span class="w"> </span><span class="no">Ht</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="no">v</span><span class="o">).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>The interpretation correctness condition for <code class="language-plaintext highlighter-rouge">assemble_identifier_rewriters</code> is very similar, where the <code class="language-plaintext highlighter-rouge">rawexpr_interp_related</code> hypothesis is replaced by an pointwise equality between the interpretation of the identifier and the interpreted value.
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_assemble_identifier_rewriters</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="nn">expr</span><span class="p">.</span><span class="no">expr</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">value</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets</span><span class="w"> </span><span class="o">(</span><span class="no">expr</span><span class="w"> </span><span class="no">t</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">d</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">decision_tree</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rew_rules</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rulesT</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">res</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">@</span><span class="no">assemble_identifier_rewriters</span><span class="w"> </span><span class="no">d</span><span class="w"> </span><span class="no">rew_rules</span><span class="w"> </span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hdo_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">UnderLets_interp_related</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hrew_rules</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">rewrite_rules_interp_goodT</span><span class="w"> </span><span class="no">rew_rules</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hv</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="no">res</span><span class="w"> </span><span class="no">v</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
      <li>We have not talked about correctness conditions for the functions we looked at in the very beginning, <code class="language-plaintext highlighter-rouge">rewrite_bottomup</code> and <code class="language-plaintext highlighter-rouge">repeat_rewrite</code>, but the correctness conditions for these two are straightforward, so we state them without explanation.
        <ul>
          <li>The <code class="language-plaintext highlighter-rouge">wf</code> correctness conditions are
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Section</span><span class="w"> </span><span class="no">with_rewrite_head</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Context</span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">),</span><span class="w"> </span><span class="o">@</span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">),</span><span class="w"> </span><span class="o">@</span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">wf_rewrite_head</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc1</span><span class="w"> </span><span class="no">idc2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">),</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">idc1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">idc2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_value_with_lets</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc2</span><span class="o">)).</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">rewrite_bottomup1</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">rewrite_head1</span><span class="o">).</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">rewrite_bottomup2</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">rewrite_head2</span><span class="o">).</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Lemma</span><span class="w"> </span><span class="no">wf_rewrite_bottomup</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w"> </span><span class="o">(</span><span class="no">Hwf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">HG</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">,</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">v1</span><span class="o">,</span><span class="w"> </span><span class="no">v2</span><span class="o">))</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">wf_value_with_lets</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_bottomup1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e1</span><span class="o">)</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_bottomup2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e2</span><span class="o">).</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">with_rewrite_head</span><span class="pi">.</span><span class="w">

</span><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">nbe</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">reflect</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc</span><span class="o">))).</span><span class="w">

</span><span class="k">Lemma</span><span class="w"> </span><span class="no">wf_nbe</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hwf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">HG</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">,</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">v1</span><span class="o">,</span><span class="w"> </span><span class="no">v2</span><span class="o">))</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">wf_value_with_lets</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">(@</span><span class="no">nbe</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e1</span><span class="o">)</span><span class="w"> </span><span class="o">(@</span><span class="no">nbe</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e2</span><span class="o">).</span><span class="w">

</span><span class="k">Section</span><span class="w"> </span><span class="no">with_rewrite_head2</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Context</span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head1</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="o">(@</span><span class="no">expr</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">),</span><span class="w"> </span><span class="o">@</span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">,</span><span class="w"> </span><span class="o">@</span><span class="no">expr</span><span class="w"> </span><span class="o">(@</span><span class="no">value</span><span class="w"> </span><span class="no">var2</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">@</span><span class="no">UnderLets</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="o">(@</span><span class="no">expr</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="o">(</span><span class="nn">type</span><span class="p">.</span><span class="no">base</span><span class="w"> </span><span class="no">t</span><span class="o">)))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">),</span><span class="w"> </span><span class="o">@</span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">wf_rewrite_head</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">do_again1</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">do_again2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">wf_do_again</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">t</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">base</span><span class="p">.</span><span class="no">type</span><span class="o">)</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">HG</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">,</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">v1</span><span class="o">,</span><span class="w"> </span><span class="no">v2</span><span class="o">))</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">),</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G'</span><span class="o">)</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">(</span><span class="no">do_again1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">do_again2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e2</span><span class="o">))</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc1</span><span class="w"> </span><span class="no">idc2</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">),</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">idc1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">idc2</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_value_with_lets</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head1</span><span class="w"> </span><span class="no">do_again1</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc1</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head2</span><span class="w"> </span><span class="no">do_again2</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc2</span><span class="o">)).</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Lemma</span><span class="w"> </span><span class="no">wf_repeat_rewrite</span><span class="w"> </span><span class="no">fuel</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="o">}</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">Hwf</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">wf</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="no">e1</span><span class="w"> </span><span class="no">e2</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="o">(</span><span class="no">HG</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">,</span><span class="w"> </span><span class="nn">List</span><span class="p">.</span><span class="no">In</span><span class="w"> </span><span class="o">(</span><span class="no">existT</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">v1</span><span class="o">,</span><span class="w"> </span><span class="no">v2</span><span class="o">))</span><span class="w"> </span><span class="no">G</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">wf_value</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="no">v1</span><span class="w"> </span><span class="no">v2</span><span class="o">),</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">wf_value_with_lets</span><span class="w"> </span><span class="no">G'</span><span class="w"> </span><span class="o">(@</span><span class="no">repeat_rewrite</span><span class="w"> </span><span class="no">var1</span><span class="w"> </span><span class="no">rewrite_head1</span><span class="w"> </span><span class="no">fuel</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e1</span><span class="o">)</span><span class="w"> </span><span class="o">(@</span><span class="no">repeat_rewrite</span><span class="w"> </span><span class="no">var2</span><span class="w"> </span><span class="no">rewrite_head2</span><span class="w"> </span><span class="no">fuel</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e2</span><span class="o">).</span><span class="w">
</span></code></pre></div>            </div>
          </li>
          <li>The interpretation correctness conditions are
            <div class="language-coq highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">Section</span><span class="w"> </span><span class="no">with_rewrite_head</span><span class="pi">.</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="k">Context</span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">(</span><span class="no">idc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">ident</span><span class="w"> </span><span class="no">t</span><span class="o">),</span><span class="w"> </span><span class="no">value_with_lets</span><span class="w"> </span><span class="no">t</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">interp_rewrite_head</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">v</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="o">(</span><span class="no">rewrite_head</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">).</span><span class="w">

</span><span class="err"> </span><span class="w"> </span><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_rewrite_bottomup</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">He</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="o">(@</span><span class="no">ident_interp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="no">rewrite_head</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="pi">.</span><span class="w">
</span><span class="k">End</span><span class="w"> </span><span class="no">with_rewrite_head</span><span class="pi">.</span><span class="w">

</span><span class="k">Local</span><span class="w"> </span><span class="k">Notation</span><span class="w"> </span><span class="no">nbe</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_bottomup</span><span class="w"> </span><span class="no">var</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">reflect</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">Ident</span><span class="w"> </span><span class="no">idc</span><span class="o">))).</span><span class="w">

</span><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_nbe</span><span class="w"> </span><span class="o">{</span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">He</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="o">(@</span><span class="no">ident_interp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="o">(@</span><span class="no">nbe</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="pi">.</span><span class="w">

</span><span class="k">Lemma</span><span class="w"> </span><span class="no">interp_repeat_rewrite</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">{</span><span class="no">rewrite_head</span><span class="w"> </span><span class="no">fuel</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">}</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">retT</span><span class="w"> </span><span class="p">:</span><span class="o">=</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="o">(@</span><span class="no">repeat_rewrite</span><span class="w"> </span><span class="p">_</span><span class="w"> </span><span class="no">rewrite_head</span><span class="w"> </span><span class="no">fuel</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hrewrite_head</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">do_again</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">Hdo_again</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kr">forall</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="o">(@</span><span class="no">ident_interp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nn">UnderLets</span><span class="p">.</span><span class="no">interp_related</span><span class="w"> </span><span class="o">(@</span><span class="no">ident_interp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related</span><span class="w"> </span><span class="o">(@</span><span class="no">ident_interp</span><span class="o">))</span><span class="w"> </span><span class="o">(</span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">e</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="no">v</span><span class="o">,</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="no">ident_interp</span><span class="w"> </span><span class="no">idc</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="no">v</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="w"> </span><span class="o">(@</span><span class="no">rewrite_head</span><span class="w"> </span><span class="no">do_again</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="no">idc</span><span class="o">)</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="err"> </span><span class="w"> </span><span class="o">(</span><span class="no">He</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nn">expr</span><span class="p">.</span><span class="no">interp_related_gen</span><span class="w"> </span><span class="o">(@</span><span class="no">ident_interp</span><span class="o">)</span><span class="w"> </span><span class="o">(</span><span class="kr">fun</span><span class="w"> </span><span class="no">t</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="no">value_interp_related</span><span class="o">)</span><span class="w"> </span><span class="no">e</span><span class="w"> </span><span class="no">v</span><span class="o">)</span><span class="w">
</span><span class="err"> </span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="no">retT</span><span class="pi">.</span><span class="w">
</span></code></pre></div>            </div>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jason Gross</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jason Gross</li><li><a class="u-email" href="mailto:jgross@mit.edu">jgross@mit.edu</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/JasonGross"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">JasonGross</span></a></li><li><a href="https://www.twitter.com/diagram_chaser"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">diagram_chaser</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Personal website of Jason Gross</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
